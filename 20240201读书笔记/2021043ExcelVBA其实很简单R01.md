## 记忆时间

2021-04-19

## 0101. 走进 Excel VBA 的世界 

VBA 就像一座神秘的城堡，对很多人来说都是神秘的。很多人想走进 VBA 的世界，却始终找不到打开大门的钥匙。什么是 VBA？ 怎样学习 VBA？ 面对这些问题，让我们从身边开始，一起探索，一起解答。

### 1.1 不会 Excel 的人，真伤不起 

1.1.1 做不完的表 

数据采集、数据处理、数据分析…… 这是小张每天都在做的工作。老板的需求和基础数据一样每天都在改变，而小张做表的速度却永远也跟不上老板敏捷的思维。不同的数据，相同的操作。小张感叹：「和数据打交道的日子，真烦！」单位来了新同事，接手小张平时的工作。

1.1.2 神速的「超人」终于告别上万条的数据，离开乱七八糟的报表，脱离「苦海」的日子，小张的日子要多舒心有多舒心。可是…… 电话里，老板那可以撑爆整幢大楼的赞扬声和新同事腼腆的笑容，让小张心里很不是滋味：「一个小时和一星期，中间的差距不仅只是时间。不会 Excel 的人，真伤不起！」

1.1.3 你是怎样做工资条的 

小张决定向新同事取取经…… 同事打开一张工资表，如图 1-1 所示，让小张把它做成工资条，如图 1-2 所示。

图 1-1 工资表 

图 1-2 工资条 

小张熟练地拿起鼠标，选中工资表头所在行 → 复制 → 选中第二条工资记录所在行 → 单击右键 → 插入复制单元格。完成后，又按同样的操作进行第三条，第四条…… 新同事看完后，笑了：「如果是 1000 条记录的工资表，这样做需要多久？」小张苦笑，也只能苦笑。工作的内容不少，但都是重复的操作。而这种重复不但枯燥而且费时，尽管小张天天时时刻刻都在做表，却永远也跟不上老板的节奏。

### 1.2 走自己的「录」，让别人重复去吧 

新同事的建议让小张感到很茫然。面对小张满脑子的疑问，新同事耐心地给他解释，并示范操作过程…… 

1.2.1 什么是宏 

就像用摄像机录下来的视频，在 Excel 里，宏就是 Excel 用户使用宏录制器录下的一组操作。选中工资表头所在行 → 复制 → 选中工资记录所在行 → 单击右键 → 插入复制单元格，这是小张制作工资条时重复的操作。

1.2.2 用宏录下 Excel 操作 

录制宏前需要进行一些简单的设置，如图 1-3 所示。

图 1-3 录制宏前的设置 

完成上述设置后就可以录制宏了，如图 1-4 所示。

图 1-4 用宏录下 Excel 操作 这样，宏就录制好了。

1.2.3 让录下的操作再现一遍 

录制完成后，通过下面的方法运行宏，如图 1-5 所示。

图 1-5 执行宏

如果要继续插入新的工资表头，就继续执行宏。

练习小课堂：学会使用录制和执行宏代替手工完成重复操作后，小张很高兴。他发现工作中很多问题都可以借助宏来提高工作效率。可是，他不明白相对引用和绝对引用的区别，你能分别录制不同的宏，执行它们，找到它们之间的区别吗？ 

参考答案：1）绝对引用：如果使用绝对引用，在执行宏的过程中，无论选中了哪个单元格，宏都在特定的单元格中执行录制的操作。2）相对引用：如果使用相对引用，在执行宏的过程中，将以活动单元格为 A1 单元格，宏在相对于活动单元格的特定单元格中执行录制的操作。如果你想让录制的宏可以在任意区域中使用，就使用相对引用。

### 1.3 还可以怎样执行宏 

【宏】对话框里的「执行」按钮就是运行宏的开关。不够方便，不够快捷，是这个开关的缺点。如果你不喜欢这个开关，可以选择其他执行宏的方法。

1.3.1 给宏设置快捷键 

录制宏前，可以在【录制新宏】对话框里为宏设置快捷键，如图 1-6 所示。

图 1-6 录制宏前为宏设置快捷键 

也可以在录制宏后进行设置，如图 1-7 所示。

图 1-7 录制宏后给宏设置快捷键 

给宏设置快捷键后，就可以按下相应的组合键执行宏。注意： 因为给宏指定的快捷键会覆盖 Excel 默认的快捷键。例如：把 `<Ctrl+C>` 指定给某个宏，那在 Excel 中按下 `<Ctrl+C> `组合键将不再执行复制操作。

1.3.2 将宏指定给按钮 

不便记忆，不易上手。快捷键虽快却不实用。无论出于什么目的，都应尽量让设计的表格显得直观一些。拿过电视机的遥控板，扫一眼就知道该按下哪个按钮来加减声音，按下哪个按钮来调节频道。如果你担心忘记为宏设置的快捷键，可以绘制一块直观形象的「遥控板」，通过单击按钮来执行宏。

图 1-8 所示为将宏指定给按钮的方法。

图 1-8 将宏指定给按钮 

如果是已经添加的按钮，可以用鼠标右键单击它，在右键菜单中执行【指定宏】菜单命令打开【指定宏】对话框，再将宏指定给按钮，如图 1-9 所示。

图 1-9 打开指定宏对话框 

当按钮呈编辑状态（如果不是编辑状态，可以先用鼠标右键单击它）时，单击按钮表面，更改标签为「生成工资条」，调整按钮的大小和位置，完成后单击按钮外的任意区域退出对按钮的编辑，如图 1-10 所示。

图 1-10 更改标签后的按钮 

完成上述设置后即可单击按钮执行宏，如图 1-11 所示。

图 1-11 单击按钮执行宏 

还可以用同样的方法将宏指定给图片或自选图形等。

1.3.3 将宏指定给常用工具栏按钮 

将宏指定给常用工具栏按钮的操作步骤如图 1-12 所示。

图 1-12 将宏指定给自定义工具栏按钮 

还可以在右键菜单中对按钮进行其他的设置，如更改按钮的名称、图像等，如图 1-13 所示。

图 1-13 设置自定义按钮 

完成后关闭【自定义】对话框，就可以单击自定义的按钮执行宏了。

### 1.4 是谁「挡住」了宏 

1.4.1 宏为什么不能工作了 

有时，打开一个保存有宏的工作簿或试图执行一个宏时，Excel 会显示如图 1-14 所示的对话框，而并不执行宏。

图 1-14 禁用宏的提示对话框 

这是小张遇到的一个新问题，他再次向新同事求助。

1.4.2 怎样修改宏安全级 

修改宏的安全级的操作如图 1-15 所示。

图 1-15 打开【安全性】对话框 

如果希望录制的宏或编写的 VBA 程序得到运行的机会，应将安全级设置为「中」或「低」。如果设置为「中」，每次打开文件时，Excel 都会显示【安全警告】对话框，让用户选择启用或禁用宏，如图 1-16 所示。

图 1-16 打开文件时的安全警告对话框 如果将安全级设置为「低」，打开文件时 Excel 不会给出任何提示并直接启用工作簿里所有的宏，如果工作簿里带有恶意代码，这样做是非常危险的，所以，建议将安全级设置为「中」。注意： 在 Excel 2003 中，修改宏安全级后需要关闭工作簿再重新打开它，修改才能生效。

### 1.5 VBA，Excel 里的编程语言 

1.5.1 录制宏不能解决的问题 

尽管可以录下用户在 Excel 里的操作，但却不能满足用户所有的需求。

1.5.2 让工资条一「输」到底 

Step 1：查看已经录制的宏，见图 1-17。

图 1-17 录制的宏 

Step 2：在第一行代码 `Sub 生成工资条 ()` 的后面添加两行新代码： 在最后一行代码 `End Sub` 的前面添加一行代码： 

图 1-18 修改后的宏 

1『

看原书里加的代码如下：

```
  Dim i As Long
  For i = 2 To 1000
  ......
  ......
  Next
```

但是看后面的代码又没有出现变量 i，目前不明白，打个标记。（2021-03-16）回复：现在清楚了，这是 VBA 里循环语句的写法，其实最后的语言完整的应该是 `Next i`，只是可以简写为 `Next`。（2021-03-23）

』

Step 3：关闭窗口，返回 Excel 工作表界面，重新执行宏，所有的工资条就全部完成了，如图 1-19 所示。

图 1-19 一次性生成所有工资条 

1.5.3 VBA 编程，让你的表格更加灵活 

不管你是否知道应该怎样修改和使用录制的宏，但从小张的故事里，应该看到了修改前与修改后的宏在工作效率上的差别。实际上，在运行宏的过程中，我们总希望能自主地判断和选择需要执行的操作或计算，而录制的宏并不能满足类似的需求。这就要求我们对宏进行适当的修改，甚至自己动手编写满足需要的代码，即：使用 VBA 编程。

1.5.4 什么是 VBA 

VBA（Visual Basic For Application）是一种编程语言，是建立在 Office 中的一种应用程序开发工具。可以利用 VBA 有效地扩展 Excel 的功能，设计和构建人机交互界面，打造自己的管理系统，帮助 Excel 用户更有效地完成一些基本操作、函数公式等不能完成的任务，从而提高工作效率。同你的名字一样，VBA 也只是一个名字，一种编程语言的名字。

1.5.5 宏和 VBA 有什么关系 

VBA 是编程语言，宏是用 VBA 代码保存下来的程序。录制的宏只是 VBA 里最简单的程序，正因为如此，录制的宏存在许多的缺陷：如无法进行判断和循环，不能显示用户窗体，不能进行人机交互…… 要想打破这些局限，让自己的程序更加自动化和智能化，仅仅掌握录制和执行宏是远远不够的，还需要掌握 VBA 编程的方法，自主地编写 VBA 程序。这就是我们学习 VBA 的目的。

## 0201. 开始 VBA 编程的第一步

优秀的运动员总是非常注重起跑的第一步。准确的姿势，恰到好处的起跑时间，再加上中间的努力拼搏，总能带给运动员优秀的成绩。比赛的最终赢家不但有过硬的运动天赋，而且一定经过长期学习和坚持训练的过程。想成为一名优秀的 VBA 编程者，最先应该了解什么？让我们一起来学习。

### 2.1 揭开神秘面纱背后的真面目 

从小张的故事里走出来，我们正式开始学习 Excel VBA。既然录制的宏就是 VBA 程序，那让我们打开第 1 章 1.2.2 小节中录制的宏所在的工作簿文件，一起研究研究。

2.1.1 程序保存在哪里 

参照图 2-1 所示的操作，可以查看宏对应的代码。

图 2-1 查看录制的宏 这个窗口是 VBE 窗口，打开它，在右面的【代码窗口】中可以看到一串代码，这就是使用宏录制器录下来的操作，以代码的形式保存在模块里。

练习小课堂：动手录几个不同的宏，比一比，宏的代码有什么共同的地方？把你总结的结论写下来，然后再继续后面的内容。

2.1.2 应该怎样编写程序 

图 2-2 所示为录制宏得到的程序。

图 2-2 录制宏得到的程序

### 2.2 程序里都有什么 

为了在编程时能更加得心应手，有必要先花点时间了解一下在编程的过程中，会反复提到的一些概念。

2.2.1 代码 VBA 的程序由代码组成，可以通过录制宏或自主编写得到 VBA 代码。

2.2.2 过程 

用 VBA 代码把完成一个任务的所有操作保存起来就是一个 VBA 过程。一个过程可以有任意多的操作，可以有任意长的代码。在本书中，只介绍 Sub 过程和 Function 过程。

2.2.3 模块

模块是保存过程的地方，一个模块可以保存多个不同类型的过程。

2.2.4 对象 

用代码操作和控制的东西即为对象，如工作簿、工作表、单元格、图片、图表、透视表等。

2.2.5 对象的属性 

每个对象都有属性，属性是对象包含的内容或特点。从对象的属性，可以了解该对角具有的性质和特点。如字体的颜色，颜色就是字体的属性；按钮的宽度，宽度就是按钮的属性。从对象的属性还可以了解到这个对象包含了哪些其他的对象。如 Sheet1 工作表的 A1 单元格，A1 单元格就是 Sheet1 工作表的属性；A1 单元格的内容，内容就是 A1 单元格的属性。在书写时，对象和属性之间用点（`.`）连接，对象在前，属性在后，如 A1 单元格的内容，用汉字表达为：`A1.内容`。 写成代码为： 

```
Range("A1").Value
```

对象的某些属性也是对象，属性和对象是相对而言的。

2.2.6 对象的方法 

每个对象都有方法，方法是指在对象上执行的某个动作。如选中 A1 单元格，「选中」是在 A1 单元格这个对象上执行的操作，就是 A1 单元格的方法。对象和方法之间也用点（`.`）连接，对象在前，方法在后，如选中 A1 单元格写成代码为： 

```
Range("A1").Select
```

2.2.7 关键字 

关键字是 VBA 中的保留字或符号，如语句名称、函数名称、运算符等都是关键字。

### 2.3 VBA 的编程环境 —— VBE

在第 2 章 2.1.1 小节中打开的窗口就是编写 VBA 程序的地方 —— VBE（Visual Basice Editor），了解 VBA 程序中经常提到的概念后，我们再花一点时间来熟悉它。

2.3.1 打开 VBE 编辑器 

要进入 VBE，首先必须启动 Excel 程序，启动 Excel 后，要切换到 VBE 窗口，常用的方法有以下几种。

方法一： 按 `<Alt+F11>` 组合键。

方法二： 依次执行【工具】→【宏】→【Visual Basic 编辑器】菜单命令，如图 2-3 所示。

图 2-3 利用菜单命令打开 VBE 

方法三： 右键单击工作表标签，执行【查看代码】菜单命令，如图 2-4 所示。

图 2-4 利用右键菜单打开 VBE 

方法四： 单击【Visual Basic】工具栏中的【Visual Basic 编辑器】按钮，如图 2-5 所示。

图 2-5 利用 Visual Basic 工具栏打开 VBE 

方法五：单击【控件工具箱】中的「查看代码」按钮，如图 2-6 所示。

图 2-6 利用控件工具箱打开 VBE 

方法六： 利用【控件工具箱】新建一个 ActiveX 控件，双击控件打开 VBE 窗口，如图 2-7 所示。

图 2-7 利用控件打开 VBE 

2.3.2 主窗口 

进入 VBE 后，首先看到的就是 VBE 的主窗口，主窗口通常由【工程资源管理器】、【属性窗口】、【代码窗口】、【立即窗口】、【菜单栏】和【工具栏】组成，如图 2-8 所示。

图 2-8 VBE 的主窗口 

2.3.3 菜单栏 

VBE 的【菜单栏】和 Excel 2003 的菜单栏类似，包含了 VBE 中各种组件的命令。

2.3.4 工具栏 

默认情况下，【工具栏】位于【菜单栏】的下面，可以在【视图】→【工具栏】菜单里显示或隐藏它，如图 2-9 所示。

图 2-9 显示或隐藏工具栏 

2.3.5 工程资源管理器 

在【工程资源管理器】中可以看到所有打开的 Excel 工作簿和已加载的加载宏，一个 Excel 的工作簿就是一个工程，工程名称为「VBA Project（工作簿名称）」。【工程资源管理器】中最多可以显示工程里的 4 类对象，即 Excel 对象（包括 Sheet 对象和 ThisWorkbook 对象）、窗体对象、模块对象和类模块对象，如图 2-10 所示。

图 2-10 工程资源管理器 

但并不是所有工程里都包含这类对象，新建的 Excel 文件只有 Excel 类对象。

2.3.6 属性窗口 

可以在【属性窗口】中查看或设置对象的属性。

2.3.7 代码窗口 

【代码窗口】由对象列表框、过程列表框、边界标识条、代码编辑区、过程分隔线和视图按钮几部分组成，如图 2-11 所示。

图 2-11 代码窗口栏 【代码窗口】是编辑和显示 VBA 代码的地方，【工程资源管理器】中的每个对象都拥有自己的【代码窗口】，如果想将 VBA 程序写在某个对象里，首先应在【工程资源管理器】中双击以激活它的【代码窗口】。反过来，如果想查看某个对象里保存有哪些程序，也必须先在【工程资源管理器】中双击以激活它的【代码窗口】。

2.3.8 立即窗口 

在【立即窗口】中直接输入命令，回车后将显示命令执行后的结果，如图 2-12 所示。

图 2-12 使用立即窗口执行代码 【立即窗口】一个很重要的用途是调试代码，相应的内容请参阅第 7 章 7.3.4 小节。如果打开 VBE 窗口后，【立即窗口】（或其他窗口）没有显示，可以在【视图】菜单中设置显示它，如图 2-13 所示。

1『自己之前就是没有立即窗口的，在「视图」里调出来了。（2021-03-18）』

图 2-13 利用视图菜单显示窗口

### 2.4 试写一个简单的 VBA 程序

运行 Excel 程序，新建一个工作簿，进入 VBE，让我们动手编写一个简单的程序，当程序运行后，用一个对话框说出现在的心情。

2.4.1 添加或删除模块 

因为 VBA 程序一般保存在模块里，所以在编写程序前，应先添加一个模块来保存它。添加模块 

方法一： 利用菜单命令插入模块的具体操作如图 2-14 所示。

图 2-14 利用菜单命令插入模块 

方法二： 利用右键菜单插入模块的具体操作如图 2-15 所示。

图 2-15 利用右键菜单插入模块 

练习小课堂：怎样添加用户窗体和类模块？试一试，然后再继续后面的内容。

参考答案 

方法一： 右键单击【工程资源管理器】中的空白处，在【插入】菜单选择要插入的对象； 方法二： 单击菜单栏中的【插入】菜单，选择要插入的对象。方法参照 2.4.1 小节中插入模块的方法。

删除模块 

如果工程中有多余的模块，可以删除它。

方法一： 利用文件菜单移除模块的具体操作如图 2-16 所示。

图 2-16 利用文件菜单移除模块 

方法二： 利用右键菜单移除模块的具体操作如图 2-17 所示。

图 2-17 利用右键菜单移除模块 

注意： 删除模块后，同时也将删除保存在该模块中的所有程序。

2.4.2 动手编写程序

Step 1： 在代码窗口中添加一个空过程，如图 2-18 所示。

图 2-18 插入空过程 

当然，你也可以在【代码窗口】中手动录入这些代码。

Step 2： 将下面的代码写到前文两行代码的中间，如图 2-19 所示。

图 2-19 添加代码后的过程 

Step 3： 运行过程，如图 2-20 所示。

图 2-20 运行程序

### 2.5 解除疑惑，一「键」倾心

对刚刚涉足 VBA 世界的我们，面对满眼陌生的代码，类似这样的困惑总是很多。如果你想知道类似 MsgBox 这样的关键字是什么意思，F1 键会是你最的好帮手，如图 2-21 所示。

图 2-21 利用 F1 键查询 MsgBox 函数的帮助信息 帮助是 Excel VBA 自带的一本百科全书，它能有效地帮助你解答在学习或编程过程中遇到的许多困惑。记住 F1 键，它是打开这本书的一把「金钥匙」。

1-2『这个操作超级有用，只要把鼠标位置放在一个函数或属性名的字母之间，按 F1 即可跳出官方的说明文档。做一张主题卡片。（2021-03-18）』—— 已完成

## 0301. Excel VBA 基础语法

厨师做菜有做菜的正确方法，一盘菜放一包盐肯定不行。司机开车有应该遵守的规则，红灯亮了不停车肯定乱套。踢足球不能用手，打篮球不能用脚。无规矩不成方圆，做什么事都有应该遵循的法则。做菜咸了，汽车乱窜了，运动员开始抱着足球满球场乱跑了…… 这些都是不遵守规则的现象。VBA 编程也有必须遵循的规则，这一章，我们将一起了解 VBA 编程应该遵循的法则 —— VBA 语法。

### 3.1 语法，编程的基础 

3.1.1 这个笑话很凉快 

什么是语法？ 语文老师说：「语法就是说话的方法，正确表达应该遵循的法则。」语法告诉我们：是妈妈煎鸡蛋，不是鸡蛋煎妈妈。鸡蛋不能说两片，应说两个。

3.1.2 VBA 也有语法 

写一个程序，就像写一篇作文，不遵循语法规则，肯定要闹笑话。工作簿该怎么称呼，工作表该怎么表示，在 VBA 里都有规定，不是随心所欲的。所以，学习 VBA 应先了解 VBA 语句的表达方式，只有这样，才能读懂并编写正确的代码。

3.1.3 学习 VBA 语法难吗 

对很多一提到语法就头痛的人，这是最担心的一个问题。学习 VBA 语法是一个打基础的过程，就像练习武功前先要日日夜夜地扎马步，练习唱歌前要天天吊嗓子。这样的过程对多数人来说是枯燥无味的，但同时又是必须的。VBA 语法究竟难不难，就看你是否能坚持学下去。

### 3.2 VBA 里的数据类型

3.2.1 打酱油的故事 

小 A 来到商店，「老板，打一斤酱油。」老板：「…… 你拿菜篮子打酱油？」离家不远，五分钟后。「老板，打酱油。」「拿个小小的花椒油瓶，你真有才。」第三次，提着水桶…… …… 选不对容器，打不回酱油。菜篮子装不了酱油；花椒油瓶装不下一斤酱油；水桶很大，能装酱油，但杀鸡却派上了牛刀…… 

3.2.2 走进 Excel 的商店 Excel 就是一间「商店」，商店里摆着各种各样的数据，作为 Excel 的用户，每天都在重复着打酱油的故事。职工编号、职工姓名、身份证号、出生年月、联系电话等，都是在 Excel 里天天打的酱油，如图 3-1 所示。

图 3-1 Excel 里的数据 

酱油是液体，面条是固体，商店的老板知道应该把谁放在桶里，把谁放在纸箱里。在 Excel 里，姓名、出生年月、基本工资这些不同的数据就像商店里不同的商品，为了便于区分，Excel 把它们分为不同的类型。如文本、日期、数值等。面对这些不同类型的数据，编写程序时，你得告诉 Excel，应该选择哪种类型的容器来保存它们，如图 3-2 所示。

图 3-2 Excel 里的数据 

3.2.3 VBA 中有哪些数据类型 

数据类型就是对同一类数据的统称，如文本、日期、数值等。VBA 里的数据类型有：字节型（Byte），整数型（Integer），长整数型（Long），单精度浮点型（Single），双精度浮点型（Double），货币型（Currency），小数型（Decimal），字符串型（String），日期型（Date），布尔型（Boolean）等，如表 3-1 所示。

表 3-1 VBA 中的数据类型     

1『这张数据类型表蛮重要的，估计以后要时常翻。详见原书。（2021-03-18）』

不同的数据类型告诉 Excel 应该以什么形式来保存它。面对不同类型的数据，在编程时，应先告诉程序按什么数据类型来保存或处理它，如图 3-3 所示。

图 3-3 不同的数据使用不同的数据类型 

练习小课堂：表 3-2 是某单位建立员工工资档案时会用到的数据，你能为它们指定最合适的数据类型吗？

表 3-2 员工信息

### 3.3 存储数据的容器：常量和变量 

3.3.1 常量和变量 

常量和变量是 VBA 存储数据的两种容器。一个酱油瓶可以打多次酱油，第一斤酱油用完了，拿到小买部满满的一瓶又提着回来。变量就像酱油瓶，可以随时随地把里面原有的酱油倒掉，再装入新的酱油。而常量就像袋装酱油的包装袋，一旦往里面装入酱油，就不能更换其他的酱油。因此，无论存储什么类型的数据，变量都可以更换内容，重复使用，而常量不可以。这是变量和常量的区别。

3.3.2 使用变量 

存储在变量里的数据可以更换，因此变量通常用来存储在程序运行过程中需要临时保存的数据或对象。

声明变量 

就像指定瓶子的名称和用途一样，声明变量就是指定变量的名称和可以存储的数据类型。可以用语句： 

```
Dim Str As String
```

声明为 String（变长）的变量最长可以串储约 20 亿个字符，见表 3-1，如果要声明定长的 String 变量，就在声明时指定它可以存储的数据的长度，如： 

```
Dim Str As String*10
```

指定变量的数据类型后，该变量只能存储指定类型的数据，而不能存储其他类型的数据。

使用变量类型声明符

```
Dim str$
```

只有部分数据类型可以使用类型声明符，如表 3-3 所示。

表 3-3 类型声明符     

| 数据类型 | 类型声明字符 |
| --- | --- |
| Integer | % |
| Long | & |
| Single | ! |
| Double | # |
| Currency | @ |
| String |  $ |

声明多个变量 

声明多个变量，可以写在同一个 Dim 后面，变量名之间用逗号隔开。也可以用不同的语句声明：

如果不指定变量类型：

什么是 Variant 

Variant 类型也称为变体型。之所以称为变体，是因为 Variant 类型的变量可以根据需要存储的数据类型改变自己的类型与之匹配。就像一个无穷大的大水缸，不管你有多少斤酱油都可以装在里面，不管是什么东西都可以装在里面。

为什么要声明变量类型 

同上街打酱油一样，尽管大水缸可以装下任意多的酱油，但如果预先已经知道自己只打一斤酱油，你会不会选择背着大水缸去？ 相比水缸，带着酱油瓶会走得更快。计算机也一样，运行程序时，数据占用的字节越小，程序运行就越快，所以，声明变量为合适的数据类型是一个好习惯。Variant 类型比其他数据类型占用更大的存储空间（见表 3-1），因此，编写 VBA 程序时，除非必须需要，否则应避免声明变量为 Variant 类型。

强制声明所有变量 

方法一 ：在模块的第一句手动输入代码：`Option Explicit`。

Step 1 ：插入一个模块，在代码窗口中输入下面的程序，如图 3-4 所示。

图 3-4 强制声明变量 

Step 2 ：运行程序，出现提示，如图 3-5 所示。

图 3-5 执行程序后出错 

方法二 ：按图 3-6 所示设置完成后，VBA 会在每个模块的第一句自动写下 `Option Explicit` 而无需用户手动输入。

图 3-6 设置强制声明变量 

还可以这样声明变量，如： 

变量的作用域 

我家厨房里的酱油瓶只供我的家人使用，因为它只属于我家。村头的那口老井，谁都可以在里面打水，因为它是全村共有的。酱油瓶和水井的作用域不同，决定了哪些人有资格使用它。变量的作用域决定变量可以在哪个模块或过程中使用。VBA 中的变量有 3 种不同级别的作用域，如表 3-4 所示。

表 3-4 变量的作用域

| 作用域 | 描述 |
| --- | --- |
| 单个过程 | 在一个过程中使用 Dim 或 Static 语句声明的变量，作用域为本过程，即只有声明变量的语句所在的过程可以使用它。这样的变量称为本地变量 |
| 单个模块 | 在模块的第一个过程之前使用 Dim 或 Private 语句声明的变量，作用域为声明变量的语句所在模块里的所有过程，即该模块里所有的过程都可以使用它。这样的变量称为模块级变量 |
| 所有模块 | 在一个模块的第一个过程之前使用 Public 语名声明的变量，作用域为所有模块，即所有模块里的过程都可以使用它。这样的变量称为公共变量 |

1-2『才知道，原来一个模块里可以写多个「过程」。过程里声明的变量是「过程变量」，过程前用 Dim 或 Private 声明的变量为「模块变量」，过程前用 Public 声明的变量为公共变量。VBA 中变量的作用域，做一张术语卡片。（2021-03-18）』—— 已完成

图 3-7 到图 3-9 所示为不同类型的变量的声明语句。

图 3-7 声明本地变量 

图 3-8 声明模块级变量 

图 3-9 声明公共变量 

注意：公共变量必须在模块对象中声明，在工作表、窗体等对象中，即使使用 Public 语句声明变量，该变量也只是模块级变量。

把数量存储到变量里

把数据存储到变量里，称为给变量赋值。如果给文本、数值、日期等数据型变量赋值，语句为： 

给变量赋值后，当使用这个数据时，可以直接使用变量名称代替对应的数据。如： 

这个程序定义一个 String 型的变量，然后给变量赋值，最后把变量的值定入活动工作表的 A1 单元格中。运行程序，结果如图 3-10 所示。

1『这里 get 到一个小知识点，在活动工作表里调用单元格对象，不用引用其父对象，之间调 `Range("A1")`。（2021-03-18）』

图 3-10 使用变量 

如果给对象变量（Object 型，如单元格）赋值，语句为：

这个程序在 Sheet1 工作表的 A1 单元格中输入文本「欢迎来到 Excel Home 论坛」，运行程序，结果如图 3-11 所示。

图 3-11 使用对象变量 

练习小课堂：如果要声明变量存储表 3-5 中的职工信息，请写出声明变量和给变量赋值的语句，把表格的内容补充完整吗？ 

表 3-5 变量存储表 

参考答案

3.3.3 使用常量 

常量通常用来存储一些固定的、不会被修改的值，如圆周率、个人所得税的税率等。常量也需要声明，声明常量不但要指定常量的名称及数据类型，还要在声明的同时给常量赋值，并且赋值后的常量不能再重新赋值。

添加模块 

如： 

常量也有作用域

同声名变量一样，在过程的中间使用 Const 语句声明的常量为本地常量，只可以在声明常量的过程里使用；如果在模块的第一个过程之前使用 Const 语句声明常量，该常量将被声明为模块级常量，该模块里的所有过程都可以使用它；如果想让声明的常量在所有模块中都能使用，应在模块里的第一个过程之前使用 Public 语句声明它。可参阅图 3-7、图 3-8、图 3-9。

2『补充到术语卡「VBA 中变量的作用域」中去。（2021-03-18）』—— 已完成

3.3.4 使用数组 

什么是数组

数组也是变量，是同种类型的多个变量的集合。

1 瓶酱油是 1 个变量，商店里，货架的第 1 层摆着 5 瓶酱油，如图 3-12 所示。

图 3-12 货架上的酱油 5 瓶酱油就是 5 个变量。因为 5 个变量都是酱油，所以可以把 5 个变量看成是由 5 个元素组成的一个数组，用「酱油」这个名称统一称呼它们。「酱油」是数组的名称，5 是数组的元素个数。

怎么表示数组里的一个元素 

客人让售货员去货架上取酱油：「左边第 2 瓶。」售货员心里默数：「1、2，对，就是你。」索引号指明元素在数组里的位置，把它和其他元素区别开来。所以，客人要的这瓶酱油用 VBA 代码可以表示为：

如果想表示货架上的第 4 瓶酱油，代码为： 

数组有什么特点：1）数组共享同一个名字，即数组名；2）数组由多个同种类型的变量组成；3）数组中的元素按次序存储在数组中，通过索引号进行区分；4）数组也是变量。

练习小课堂：生活中很多地方都在使用数组。七年级（6）班有 50 个同学，你知道「七年级 6 班（12）」表示什么吗？如果想表示七年级（6）班第 35 位同学用 VBA 代码该怎么写？ 

参考答案：1）「七年级 6 班（12）」表示七年级 6 班的第 12 位同学。2）七年级 6 班的第 35 位同学用 VBA 代码表示为：七年级 6 班（35）。

声明数组 

数组有大小。数组的大小告诉 VBA，这个数组最多可以存储多少个元素。初一学生报名入学后开始分班级，校长说：「七 6 班分 50 个学生」，50 就确定了「七 6 班」这个数组的大小：

这个班最多只能有 50 个同学。校长的这个举动就是在声明数组。声明数组除了要指定数组名称及数据类型，还应指定数组的大小。所以，「七 6 班」这个数组用 VBA 代码可以这样声明： 

给数组赋值 

分班后，班主任老师拿着学生花名册开始给同学编学号。1 号是张青，2 号是邓成……50 号是冯吉。这就是给数组赋值的过程。给数组赋值，同给变量赋值一样。如要把「孔丽」这个字符串赋给一维数组 arr 中的第 20 个元素，代码为： 

给数组赋值时，要分别给数组里的每个元素赋值，赋值的方法与给变量赋值相同。给学生分班和编学号的过程可以用 VBA 代码写成： 

声明数组时，也可以用一个自然数指定数组元素的大小，该自然数为数组的最大索引号，如：

```
arr(20) = "孔丽"
```

如果在模块的第一句写上 `Option Base 1`，尽管只使用一个自然数确定数组的大小，数组起始索引号也是 1，而不是 0。

练习小课堂：试一试，用 VBA 代码声明一个 10 个元素的 Integer 类型的数组，并将 1 到 10 的自然数保存到数组里，你能做到吗？ 

参数组的维数 

无论货架上的 5 瓶酱油，还是七 6 班的 50 个同学，都可以把它们看成是整整齐齐排成一个横排的元素。第 1 个，第 2 个，第 3 个…… 第 20 个…… 第 50 个，总是可以这样引用它们。像这样排成一个横排的数组，称为一维数组。除了一维数组，在 VBA 中还可以使用多维数组。货架共有 3 层，每层 5 瓶酱油，这时，数组里的元素不再是排成一个横排而是三个，或者说，这个数组由三个一维数组组成，如图 3-13 所示。

图 3-13 三层货架上的酱油 

这样由多个横排组成的数组称为二维数组，二维数组可以看成由多个一维数组组成。买酱油的客人说：「我要第 2 层的第 4 瓶。」写成 VBA 代码就是：

声明多维数组 

货价有 3 层，每层 5 瓶酱油。如果要声明这个数组，语句为： 

这个语句可以改写为： 

练习小课堂：七年级有 8 个班，每班 50 个同学，你能声明一个名称为「七年级」的二维数组保存这 8 个班同学的姓名吗？如果要把七年级 7 班的第 30 个同学的姓名「张林」赋给数组里对应的元素，你知道代码应该怎么写吗？

参考答案：

如果有 3 个货架，每个 3 层，每层摆 5 瓶酱油，如图 3-14 所示。

图 3-14 摆满 3 层货架上的酱油

「第 2 个货架第 3 层的第 4 瓶酱油。」这也是数组「酱油」里的 1 个元素，用 VBA 代码表示为： 

这样的数组，可以视为由多个二维数组组成，称为三维数组。还有四维、五维，甚至更多维的数组。在 Excel 里，写在一个单元格里的数据就像货架上的一瓶酱油，工作表中的一行就像一层货架，一张工作表或一个单元格区域就是一个多层的货架，两张工作表就是两个货架，两个工作簿就是放着相同货架的两个商店…… 

练习小课堂：如果 1 个学生姓名占 1 个单元格，把 1 个存储 100 个学生姓名的一维数组「七年级」写入 Excel 工作表的单元格里，会占多大的区域？

参考答案：

因为 1 个单元格存储一个学生姓名，所以把存储 100 个学生姓名的一维数组写入 Excel 工作表中应占同一行里连续的 100 个单元格，如：`A1:CV1` 区域。

声明动态数组 

如果在声明数组时，不能确定会往这个数组里存储多少个元素，即不能预知数组的大小，可以在首次定义数组时括号内为空，写成： 

然后在程序中使用 ReDim 语句重新指定它的大小。如：A 列有很多职工姓名，想把这些职工姓名存储在数组 arr 中，但预先并不知道 A 列的职工姓名有多少个，在定义数组时代码可以这样： 

```c
Sub dtsz()
  Dim arr() As String
  Dim n As Long
  ' 统计 A 列有多少个非空单元格
  n = Application.WorksheetFunction.CountA(Range("A:A"))
  reDim arr(1 To n) As String
End Sub
```

1『这里收获一个比较重要的功能，如何获取某一列非空单元格的个数。做一张任意卡片。（2021-03-18）』—— 已完成

用这样的方式声明的数组称为动态数组。注意：已经定义大小的数组同样可以用 ReDim 语句重新指定它的大小。其他常用的创建数组的方式如下：

1-2『 VBA 里常见的数组创建的方法，做一张主题卡片。（2021-03-18）』—— 已完成

方法一： 使用 Array 函数创建数组 

运行上述代码，结果如图 3-15 所示。

```c
Sub ArrayTest()
  Dim arr As Variant
  ' 将 1 到 10 是个自然数赋值给数组 arr
  arr = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
  MsgBox "arr 数组的第 2 个元素为：" & arr(1)
End Sub
```

1『这里发现，VBA 中字符串的「连接符」用的跟 Python 一样，哈哈。（2021-03-18）』

图 3-15 使用 Array 函数创建数组 

方法二： 使用 Split 函数创建数组 

Split 函数把一个文本字符串按照指定的分隔符分开，返回一个一维数组，数组最小索引号是 0。运行上述代码，结果如图 3-16 所示。

```c
Sub SplitTest()
  Dim arr As Variant
  ' 利用 split 生成数组 arr
  arr = Split("1,2,3,4,5,6,7,8,9,10", ",")
  MsgBox "arr 数组的第 2 个元素为：" & arr(1)
End Sub
```

图 3-16 使用 Split 函数创建数组 

方法三： 通过 Range 对象直接创建数组 

如果想把一个单元格区域的值直接存储到数组里，可以直接把单元格区域的值赋给变量名。如： 

```c
Sub RngArr()
  Dim arr As Variant
  arr = Range("A1:C3").Value
  Range("E1:G3").Value = arr
End Sub
```

运行上述代码，运行结果如图 3-17 所示。

图 3-17 通过 Range 对象创建数组 

UBound 和 LBound 函数 

使用 UBound 和 LBound 函数可以计算数组的最大和最小索引号。一个一维数组 arr，要想知道它的最大索引号是多少，代码为： 

```c
UBound(arr)
```

如果想知道它的最小索引号，代码为：

```c
LBound(arr)
```

如果想知道数组有多少个元素，可以使用代码：

```c
UBound(arr) - LBound(arr) + 1
```

如： 

运行上述代码，结果如图 3-18 所示。

图 3-18 使用 UBount 和 LBound 函数 

如果是一个多维数组，求它的最大或最小索引号，还需指定数组的维数，如： 

运行上述代码，结果如图 3-19 所示。

图 3-19 数组的最大索引号 

Join 函数 

Join 函数将一个一维数组里的元素使用指定的分隔符连接成一个新的字符串。运行上述代码，结果如图 3-20 所示。

图 3-20 使用 Join 函数 

```c
Sub JoinTest()
  Dim arr As Variant, txt As String
  arr = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
  arr = Join(arr, "@")
  MsgBox arr
End Sub
```

将数组写入单元格区域

如想将一维数组 arr 里的第 23 个元素写入活动工作表中的 A1 单元格，代码为： 

```c
Range("A1").Value = arr(23)
```

也可以将数组里的所有元素批量写入一个单元格区域：

```c
Sub JoinTest()
  Dim arr As Variant, txt As String
  arr = Array(1, 2, 3, 4, 5, 6, 7, 8, 9)
  ' 将数组批量写入单元格
  Range("A1:A9").Value = Application.WorksheetFunction.Transpose(arr)
End Sub
```

备注：将一维数组写入单元格区域，单元格区域必须在同一行。如果要写入垂直的一列单元格区域，必须先使用工作表的 Transpose 函数进行转换。

1-2『原来默认是写同一行，如果要写同一列就得用 `Transpose` 函数转换。再一次看到对象 `Application.WorksheetFunction` 里的一个实用方法，前面还有一个统计非空单元格的 `CountA`，去帮助文档里去看看该对象到底有哪些方法。感觉以后很多功能的实现需要靠这个对象里的方法。（2021-03-18）』—— 未完成

运行上述代码，结果如图 3-21 所示。

图 3-21 将一维数组批量写入单元格区域 

无论是一维数组还是二维数组，将数组批量写入单元格区域时，单元格区域的大小必须与数组的大小一致，如：运行上述代码，结果如图 3-22 所示。

1『原书里的例子是直接把一个数组写进一块单元格区域。备注：6 个元素，对应 6 个单元格，且数组与单元格都是 2 行 3 列。（2021-03-18）』

图 3-22 单元格的大小必须与数组的大小一致

### 3.4 集合、对象、属性和方法 

3.4.1 对象，就像冰箱里的鸡蛋 

什么是对象 

对象就是东西，是用代码操作和控制的东西，属于名词。打开工作簿，工作簿就是对象；复制工作表，工作表就是对象；删除单元格，单元格就是对象…… 

对象的层次结构 

厨房里放着冰箱，冰箱里有碗，碗里装着早餐要吃的鸡蛋。无论是厨房、冰箱、碗还是鸡蛋，都是东西，都是对象，如图 3-23 所示。

图 3-23 厨房的结构图 

厨房里除了冰箱，还有消毒柜和电饭锅；冰箱里放着装有鸡蛋的碗，还放着装着水果的盘子和装着牛奶的瓶子，如图 3-23 所示。

图 3-24 厨房里的多个对象 

一个 Excel 工作簿就像一间大厨房，一个工作簿里可以有多张工作表，一张工作表里有多个单元格区域，如图 3-25 所示。

图 3-25 工作簿里的对象 

一个对象可以包含其他对象，同时又包含在其他对象里，不同的对象总是这样有层次地排列着。

集合 —— 多个同类型的对象 

集合也是对象，是对多个同种类型的对象的统称。冰箱里有很多碗，无论装着鸡蛋还是瘦肉，都属于同一类对象，可以统称为「碗」。但是这个集合里并没有装牛奶的瓶子，因为瓶子不是碗，和碗不属于一类。一个打开的工作簿，里面有多张工作表，无论工作表的名称是什么，表里保存什么数据，它们都属于工作表集合，即：Worksheets。

怎样取到装鸡蛋的碗 

要吃鸡蛋，让孩子去取。「去厨房，把冰箱里装着鸡蛋的碗拿来。」碗存放的地点（厨房的冰箱里）以及碗的特征（装着鸡蛋）都要介绍清楚，这样，孩子才不会弄错。

VBA 中怎样取到集合里的一个对象 

取到想要取的对象，称为「引用对象」。很多个工作簿，若干张工作表，数不清的单元格，怎么表示 "Book1" 工作簿中 "Sheet2" 工作表中的 "A2" 单元格？ 就像取冰箱里装鸡蛋的碗一样，在哪间房的冰箱里拿，拿什么碗，都要叙述清楚。

```c
Application.Worksheet("Book1").Worksheets("sheet2").Range("A2")
```

引用对象就像引用硬盘上的文件，要按从大到小的顺序逐层引用。但并不是每一次引用对象都必须严谨地从第 1 层开始。如果 Book1 工作簿是活动工作簿，前面的代码可以写为：

```c
Worksheets("sheet2").Range("A2")
```

如果 Sheet2 工作表是活动工作表，代码甚至还可以简写为： 

```c
Range("A2")
```

3.4.2 对象的属性 

什么是属性 

每个对象都有属性。对象的属性可以理解为该对象包含的内容或具有的特点。苹果是有颜色的，颜色就是苹果的属性。我的衣服，衣服就是我的属性。Sheet2 工作表的 A2 单元格，A2 单元格是 Sheet2 工作表的属性；A2 单元格的字体，字体是 A2 单元格的属性；字体的颜色，颜色是字体的属性。「的」字后面的，总是「的」字前面的对象的属性。

在 VBA 中，用点（`.`）代替「的」字： 

我的衣服 → 我.衣服 

Sheet2 工作表的 A2 单元格的字体的颜色 → `Worksheets ("Sheet2").Range ("A2").Font.Color` 

对象的相对性 

某些对象的某些属性，返回的是另一个对象，如 Sheet1 工作表的 Range 属性，返回的是 e 对像（即单元格），但单元格本身也是一种对象。作为一种对象，它也有自己的属性，如字体（Font），而字体也是对象，也有属性，如颜色。对象和属性是相对的。单元格相对于字体是对象，相对于工作表是属性。如果想准确地知道 Value（或其他）是方法还是属性，可以在【代码窗口】中将光标定位到它的中间，按 F1 键，查看帮助里的信息，如图 3-26 所示。

图 3-26 查看 Value 的帮助信息

3.4.3 对象的方法 

什么是方法 

方法是在对象上执行的某个操作，属于动词。如剪切单元格，剪切是在单元格上执行的操作，就是 Range 对象的方法；选中工作表，选中是在工作表上执行的操作，就是 Wroksheet 对象的方法；保存工作簿，保存就是 Workbook 对象的方法…… 

方法和属性的区别 

属性返回对象包含的内容或具有的特点，如颜色、大小等。方法是对对象的一种操作，如选中、激活等。

怎样分辨方法和属性 

除了通过查看帮助来分辨属性和方法，还可以在【代码窗口】中按 `<Ctrl+J>` 组合键，或者在对象的后面写上点，在自动显示的【属性／方法列表】中根据图标的颜色来分辨，带绿色图标的项是方法，其他的都是属性，如图 3-27 所示。

图 3-27 对象的属性／方法列表 

如果在对象的后面输入点后没有显示【属性／方法列表】，则先在【选项】对话框的【编辑器】选项卡里勾选【自动列出成员】复选框，如图 3-27 所示。

1-2『不错不错，自动显示属性和方法，这个设置去弄一下。（2021-03-18）』—— 未完成

图 3-28 设置自动列出成员

### 3.5 连接的桥梁，VBA 中的运算符 

程序执行的过程就是对数据进行运算的过程。不同的数据类型可以进行不同的运算，按数据运算类型的不同，VBA 里的运算符主要分为算术运算符、比较运算符、连接运算符和逻辑运算符。

3.5.1 算术运算符 

算术运算符用于算术运算，返回值的类型为数值型。`3+1`，`5−4`，`6*8`，`7^4`，这些都是算术运算。算术运算符包括 +、−、*、/、\、^、Mod 等，各运算符的作用如表 3-6 所示。

表 3-6 算术运算符及作用

| 运算符 | 作用 | 示例 |
| --- | --- | --- |
| \ | 整除（两数相除取商的整数） | 5\2=2 |
| Mod | 求模运算（两数相除取余数） | 12 Mod 9=3 |
| - | - | - |
| - | - | - |

3.5.2 比较运算符 

比较运算符用于比较运算，如比较两个数的大小。返回值为 Boolean 型，只能为 True 或 False。比较运算符及其作用如表 3-7 所示。

表 3-7 比较运算符及作用 

1『做逻辑判断的时候，这里的比较运算符很重要，原书里的这张表可以常常去翻。其中发现竟然可以用「通配符」去匹配字符串，通配符的关键词是 `Like`。（2021-03-18）』

在图 3-29 所示的成绩表中，如果要知道第一条记录中学生的总分是否达到 500 分，语句为： 

如果要判断 B2 单元格里的考生是否姓李，代码为： 

图 3-29 学生成绩表 

练习小课堂：如果想知道 B2 单元格的考生姓名里是否有「刚」字，代码该怎么写？ 

参考答案：

除了 `*`，Like 运算还可以使用其他通配符。VBA 中的通配符及其作用如表 3-8 所示。

表 3-8 VBA 中的通配符    

| 通配符 | 作用 | 示例 |
| --- | --- | --- |
| `*` | 代替任意多个字符 | "李家军" Like `*家*` = True  |
| ? | 代替任意的一个字符 | "李家军" Like "李??" = True  |
| # | 代替任意的一个数字 | - |
| [charlist]  | 代替位于 charlist 中的任意一个字符 |  "I" Like "[A-Z]" = True |
| [!charlist]  | 代替不在 charlist 中的任意一个字符  | "I" Like "[!H-J]" = False |

1『感慨：通配符在哪个语言里都会出现，说明是一个很基础的东西。（2021-03-18）』

练习小课堂：根据图 3-29 所示的学生成绩表，用学过的运算符，你能写出其他表达式吗？请任意写出 4 个填在下面的表格里，然后再继续后面的内容。

参考答案：

3.5.3 连接运算符 

连接运算符用来连接两个文本字符串，有 `+` 和 `&` 两种，如图 3-30 所示。

图 3-30 在立即窗口中使用连接运算符 `+` 可以用作算术运算的加运算，也可以用于文本连接运算。如果 `+` 运算符两边的表达式都是文本字符串，则执行连接运算；如果 `+` 运算符两边的表达式包含数值，则执行算术运算，如图 3-31 所示。

图 3-31 在立即窗口中使用 `+` 运算符 

当使用 `&` 运算符时，无论运算符左右两边是何种尖型的数据，都执行连接运算。

3.5.4 逻辑运算符 

逻辑运算符用于判断逻辑运算式的真假，参与运算的数据为逻辑型数据，返回结果为 Boolean 型，只能为 True 或 False。辑逻运算符及其作用如表 3-9 所示。

表 3-9 逻辑运算符及作用 

图 3-29 所示的学生成绩表，如果想判断第一条记录中语文、数学两个学科中是否有及格（大于或等于 60 分）的科目，语句为： 如果语文成绩和数学成绩分别为 85 分和 49 分，则这个表达式的计算过程可以用脱等式表示为：

3.5.5 应该先进行什么运算 

在 VBA 中，要先处理算术运算符，接着处理连接运算符，然后处理比较运算符，最后再处理逻辑运算符。可以用括号来改变运算顺序。运算符按运算的优先级由高到低的次序排列为：括号 → 指数运算（乘方）→ 求相反数 → 乘法和除法 → 整除（两数相除取商的整数）→ 求模运算（两数相除取余数）→ 加法和减法 → 字符串连接 → 比较运算 → 逻辑运算，如表 3-10 所示。

表 3-10 运算符的优先级 

练习小课堂：用脱等式计算出下面表达式的结果。

### 3.6 内置函数 

3.6.1 VBA 中的函数 

合理使用函数不但可以节省处理数据的时间，提高工作效率还可以降低编程的难度，减少编写代码的工作量。作为一种编程语言，VBA 中也有函数。在 VBA 中使用 VBA 内置函数与在工作表中使用工作表函数类似，如想知道当前的系统时间可以用 Time 函数（见图 3-32）。

图 3-32 利用 Time 函数返回当前系统时间 

3.6.2 VBA 中有哪些函数 

VBA 中的所有函数都可以在帮助里找到，如图 3-33 所示。

图 3-33 在 VBA 帮助中查看函数 

函数很多，我们并不用很精确地全部记住它们，只需大概了解即可，如果在编写代码时，忘记了某个函数的拼写，可以在【代码窗口】中先键入 `VBA.`，系统会自动显示【函数列表】供你选择，如图 3-34 所示。

1-2『这个小技巧好，如何查看 VBA 里的内置函数，做一张任意卡片。（2021-03-18）』—— 已完成

图 3-34 自动显示函数列表

### 3.7 控制程序执行，VBA 的基本语句结构 

3.7.1 If…Then 语句 

应该选择什么问候语「应该选择什么问候语？」这是小丽的烦恼。她带着这个问题走进了 VBA 课堂…… 

If 语句来帮忙 

针对小丽的问题，老师给她提了一个建议。把这句 VBA 代码译为汉语就是： 

练习小课堂：试一试，如果中午 12 点后提示下午好，你能仿照老师写的代码写一个这样的语句吗？ 

当需要判断两次时 

如果时间在 12 点之前，提示「上午好！」，否则提示「下午好！」，像这样的问题可以用 `If…Then` 来编号不同的句子。如： 

相当进行两次比较运算时，这种语句并不是最佳的选择，可以只用一个 if 语句代替它： 

练习小课堂：你还能用 `If…Then…Else` 造其他的句子吗？「如果活动工作表的 A1 单元格为空，则提示‘没有输入内容’，否则提示‘已经输入内容’」。把这个句子翻译出来，并运行它，看自己写对了吗？ 

如果你不习惯阅读一行很长的代码，还可以把 If 语句写成块的形式，我们也不推荐将二次判断的 If 语句写成一行。这些代码是怎么工作的「如果…… 那么…… 否则」，If 语句总是可以用这个句式来描述它的执行流程。结合这个思路，可以给 If 语句绘制出执行的流程图，如图 3-35 所示。

图 3-35 If 语句的流程图 

你知道吗？ 把程序写在【代码窗口】里，将光标定位在程序的中间，可以按 F8 键逐句执行语句观察程序的执行流程。

1-2『这个小技巧还真不知道。做一张任意卡片。（2021-03-18）』—— 已完成

更多判断的时候 

不仅要判断时间是否大于中午 12 点，还要判断是否大于下午 6 点。需要对条件判断两次以上，这是小丽遇到的新问题。小丽带着这个问题去求助老师，老师教给她另一种解决方法。

3.7.2 Select Case 语句 

尽管使用 If 语句可以有效地解决多次判断的问题，当面对在 3 种或更多策略中做出选择时，使用 Select Case 语句会更适合。

练习小课堂：第 3 章 3.7.2 小节中的程序，如果省略 Case Else 子句，应该怎样写？ 

参考答案 ：

Select Case 语句的执行流程，与 If…Then…ElseIf 语句一样，可以在【代码窗口】中按 F8 键观察得到：程序将 Select Case 后面的测试表达式与各个 Case 子句后面的表达式列表进行对比，如果测试表达式的值在表达式列表中，则执行对应的子句，然后退出整个语句块，执行 End Select 后面的语句，否则将继续进行判断，如图 3-36 所示。

图 3-36 Select Case 语句的执行流程图 

因为 Select Case 语句一旦找到匹配的值后即跳出整个语句块，所以，为了减少判断的次数，在设置条件时，应尽量把最有可能发生的情况写在前面。

1『不错不错，确认了 Select Case 语句一旦找到匹配的值后即跳出整个语句块，基本其他语言都有，AutoLisp 里换了个关键词 `cond`。』

练习小课堂：表 3-11 是给学生成绩评定等级的程序，其中有部分代码或代码说明没有写出来。请你把它补充完整，然后运行程序，看自己都写对了吗？ 

参考答案：

学会用判断语句选择合适的问候语，小丽很高兴。笑过之后，她惊奇地发现，原来工作中每天都在做着类似的判断。图 3-37 所示为单位职工考核得分表。

图 3-37 职工考核得分表 

现要根据考核得分，按图 3-38 所示的星级评定标准为职工评定星级。

图 3-38 星级评定标准 

小丽决定用 Select Case 语句编写一个程序来解决这个问题。

3.7.3 For…Next 语句 

小丽对自己写的程序很满意。但是，在工作中需要处理的数据却复杂得多，如图 3-38 所示。

图 3-39 实际上需要处理的数据 

小丽求助老师，老师说，可以使用 For…Next 循环语句批量处理。可以结合 For…Next 语句的执行流程图来理解这个程序，如图 3-40 所示。

图 3-40 For…Next 循环语句执行流程图 

For…Next 语句总是写成这样： 老师给小丽的程序是这样的：

首先定义循环变量 i 的初值和终值分别是 2 和 19，当程序执行到 For 语句时，判断变量 i 的值是否大于终值 19，如果不大于，则执行 For 和 Next 中间的语句，直到 Next 语句，再返回 For 语句处再次进行判断，直到循环变量的值大于终值 19，退出循环，执行 Next 后面的语句。

练习小课堂：1）根据代码说明，把表 3-12 中的程序补充完整，让程序运行后，能把 100 以内的正奇数按 1, 3, 5, 7…… 的顺序写进 A 列的单元格里。2）你还能用同样的方法找出 100 以内能被 3 整除的数，并按顺序写入 A 列单元格吗？试一试。

参考答案 ：

3.7.4 Do While 语句 

如果使用 Do While 语句来解决 3.7.3 小节中为职工评定星级的问题，可以把第一条记录作为起点，依次判断 H 列的单元格是否为空。如果不为空，则执行 Select Case 语句进行星级评定，直到单元格内容为空退出循环。还可以在结尾处判断循环条件，语句为：

Do While 循环语句是当逻辑表达式的值为 False 时退出循环，但结尾判断式的语句是在执行一次循环体后再判断循环条件，因此，当循环条件一开始就为 False 时，比开头判断式要多执行一次循环体，其他时候执行次数相同。

练习小课堂：试一试，用结尾判断式的 Do While 语句来解决 3.7.3 小节中为职工评定星级的问题。

3『

设计流里提取暖通设备数据的代码（2021-03-24）：

```c
Public Sub ExtractEquipDataToCSV()
  Dim fso As Object
  Dim myTxt As Object
  Dim MyFName As String
  Dim row As Integer, column As Integer
  
  MyFName = "D:\dataflowcad\nsdata\tempEquip.csv"
  
  Set fso = CreateObject("Scripting.FileSystemObject")
  Set myTxt = fso.CreateTextFile(Filename:=MyFName, OverWrite:=True)

  row = 1
  column = 1
  Do While Range("B2:U100").Cells(row, 1).Value <> ""
    For column = 1 To 20
      myTxt.Write ","
      myTxt.Write Range("B2:U100").Cells(row, column).Value
    Next column
    myTxt.Write vbCr
    row = row + 1
  Loop

  myTxt.Close
  Set myTxt = Nothing
  Set fso = Nothing
  MsgBox "Extract Sucess!"
End Sub
```

』

3.7.5 Do Until 语句 

Do Until 语句也有开头判断和结尾判断两种语句形式。

开头判断式：

结尾判断式： 

与 Do While 语句不同的是：Do While 语句是当逻辑表达式的值为 False 时退出循环，而 Do Until 语句是当逻辑表达式的值为 True 时退出循环。

练习小课堂：试一试，分别用 Do Until 语句的两种形式编写程序来解决 3.7.3 小节中评定职工星级的问题。

3.7.6 For Each…Next 语句 

当前活动工作簿中有许多工作表，但并不知道数量。如果要把所有工作表的名称按次序写入活动工作表的 A 列，For Each…Next 是更适合的循环语句。无论工作簿中有多少张工作表，执行程序后，都会将所有工作表的标签名称依次写入当前活动工作表的 A 列单元格中，如图 3-41 所示。

```c
Sub shtname()
  Dim sht As Worksheet, i As Integer
  i = 1
  For Each sht In Worksheets
    Cells(i, "A") = sht.Name
    i = i +1
  Next sht
End Sub
```

1-2『

上面代码注意点：1）`Dim sht As Worksheet` 定义变量，因为是在工作表集合里循环，所以变量类型必须定义为 Worksheet，即工作表类型。2）Worksheets：当前活动工作簿中的所有工作表的集合，集合里有几个工作表对象，运行程序后就执行循环体几次。

For Each…Next 相当于 PHP 里的 `foreach` 循环体，循环体里可以对单个元素 sht 调用各种方法。这个以后应该经常会用到，目前不知道 VBA 里有没有对数组的映射函数。待确认。

』

图 3-41 把工作表标签名称写入 A 列 

使用 For Each…Next 循环语句时，不需要定义循环条件，如果要在一个集合或一个数组中循环时，同其他循环语句相比，For Each…Next 要灵活得多。注意： 当在一个数组里循环时，不能对数组元素进行赋值或重新赋值，对于已经赋值的对象数组也只能修改元素的属性。

练习小课堂：用 For Each…Next 语句编写一个程序将 1 到 100 的自然数输入 A1:A100 单元格区域。

3.7.7 其他的常用语句 

GoTo 语句，让程序转到另一条语句去执行 

GoTo 地点，译成中文是「去到指定的地点」。在 VBA 中，GoTo 语句也可以这样理解。在 VBA 中，指定地点可以在目标代码所在行前加上一个带冒号的字符串或不带冒号的数字作为标签，然后在 GoTo 的后面写上标签名。如： 

GoTo 语句大多用于错误处理时，参阅 7.4 小节，因为它会影响程序的结构，增加阅读和调试的难度，所以除非必须需要，否则应尽量避免使用 GoTo 语句。

With 语句，让代码更简单 

当需要对相同的对象进行多次操作时，往往会编写一些重复的代码。如： 

这是一个设置 A1 单元格字体的程序。因为是对同一个对象的多个属性进行设置，所以 4 行代码的前半部分都是相同的。如果你不想多次重复录入相同的代码，可以用 With 语句来简化输入。合理使用 With 语句，不但可以减少代码的输入量，还能提高程序的运行效率。

### 3.8 Sub 过程，基本的程序单元 

做什么事都有一个过程。烧水，倒水，拿毛巾…… 倒水，这是洗脸的过程。买菜，洗菜，切菜，炒菜，盛菜，这是做菜的过程。打开工作簿，输入数据，保存工作簿，退出 Excel 程序，这是数据录入的过程。过程就是做一件事情的经过，由不同的操作按先后顺序排列、组合起来。

3.8.1 关于 VBA 过程 

什么是 VBA 过程 

打开工作簿，输入数据，保存工作簿，退出 Excel 程序。这是一个录入数据的过程。把这些操作写成 VBA 代码，按先后顺序组合起来就是一个 VBA 过程。所以，VBA 过程就是完成某个给定任务的代码的有序组合。

VBA 里有哪些过程 

VBA 的基本过程有 Function 过程和 Sub 过程两种。

3.8.2 编写 Sub 过程需要了解的内容 

关于 Sub 过程 录制的宏就是 Sub 过程，录制宏也只能生成 Sub 过程。可以录制一个复制 A1:A8 单元格到 C1:C8 单元格的宏，结合宏来认识 Sub 过程的结构。知道了过程的结构，就可以依葫芦画瓢，像做填空题一样随心所欲地编写 Sub 过程了。

应该把过程写在哪里 

宏保存在哪里，还记得吗？是的，模块。过程也是保存在模块里。和录制的宏一样，过程保存在模块里，所以编写过程，应先插入一个模块来保存它（参阅 2.4.1 小节），插入模块后，双击激活它的【代码窗口】，就可以在【代码窗口】中编写过程了。

练习小课堂：学会编写 Sub 过程后，你有什么想要完成的操作？试着编写一个过程，让程序替你完成。

答案参考书中的任意一个 Sub 过程。并不是只有模块对象才能保存过程，Excel 对象（或窗体对象）也能保存过程，如图 3-42 所示。

图 3-42 Excel 类模块 

为了避免发生错误，建议将 Sub 过程和 Function 过程保存模块对象中。和一个文件夹可以保存多个文件一样，一个模块也可以保存多个过程。如果需要，你也可以像给文件分类那样，建不同的模块来保存功能不同的过程。

声明 Sub 过程，规范的语句 

尽管一个 Sub 过程可以包含任意多的代码，但就像做 20 桌饭菜，为了更有效、更有条理地把任务完成，总是需要有明确的分工：张三洗菜，负责完成洗菜的过程，李四烧饭，负责烧饭的过程，最后把大家的过程合起来就完成了整个任务。分工后，哪个过程出现问题，比如菜没洗干净，就直接去找张三。编程也一样，当需要处理的任务比较复杂时，可以用多个小过程去完成，每个过程负责完成一个特定的、较为简单的目的，最后通过执行这些小过程来完成最终目的。

3.8.3 从另一个过程执行过程 

下面是在 3.7.1 小节中编写的过程： 如果想在另一个过程里使用代码执行它，常用的方法有如下三种。

方法一 ：输入过程名称以及参数，参数用逗号隔开。

```c
Sub RunSub()
  SayHello
End Sub
```

方法二 ：在过程名称以及参数前使用 Call 关键字，参数用括号括起来，并用逗号隔开。

```c
Sub RunSub_2()
  Call SayHello
End Sub
```

方法三 ：利用 Application 对象的 Run 方法，语句形式如下。

```c
Application.Run "SayHello"
```

3.8.4 过程的作用域 

过程按作用域的不同分为公共过程和私有过程。

公共过程 

公共厕所、公共汽车…… 戴着「公共」的帽子，意味着这个东西大家都可以使用。

私有过程 

家里买了一辆私家车，肯定不会让街上的每个人都坐着它去上班。哪辆是公共汽车，哪辆是私家车，为了区别开来，要给它贴上特殊的标识。如果想把模块中的所有过程全部声明为私有过程（包括已经声明为公共过程的过程），只需在模块中第一个过程之前写上 `Option Private Module` 即可，如图 3-42 所示。

图 3-43 将模块里所有过程声明为私有过程 

谁有资格调用私有过程 

如果一个过程被声明为私有过程，只有这个模块里的过程才能调用它。如果想让其他模块中的过程也能调用，应该把它声明为公共过程。私有过程不会在【宏】对话框里显示，如图 3-44 所示。

图 3-44 私有过程不在宏对话框里显示 

练习小课堂：编写过程，分别调用不同模块的私有过程和公共过程，都能调用吗？ 

参考答案：可以调用其他模块中的公共过程，不能调用其他模块中的私有过程。

### 3.9 自定义函数，Function 过程 

Function 过程也称为函数过程。编写一个 Function 过程，就编写了一个函数。函数可以完成很多复杂的计算。如想求 A 列的和，可以用 `SUM` 函数；想知道 A 列有多少个「张三」，可以用 `COUNTIF` 函数。Excel 并没有提供解决这个问题的工作表函数。这时，可以根据需要自己编写一个。

3.9.1 试写一个函数 

Function 过程同 Sub 过程一样，都是保存在模块里，所以，在编写函数前，应先插入一个模块（参阅第 2 章 2.4.1 小节）来保存它。插入模块后，双击模块激活它的【代码窗口】，即可开始编写函数。如果想让函数生成一个 1-10 之间的随机整数，完整的程序为： 

```c
Public Function Fun()
  Dim arr As Variant, txt As String
  Fun = Int(Rnd()*10) + 1
End Function
```

3.9.2 使用自定义函数 

自定义的函数可以在工作表中使用，也可以在 VBA 过程里使用。

在工作表中使用自定义函数 

在工作表中使用自定义函数同使用工作表函数类似，如图 3-45 所示。

图 3-45 在工作表中使用自定义函数 

1『自定义函数竟然可以跟原生函数一样在 Excel 表里使用，赞。（2021-03-24）』

自定义的函数可以在【插入函数】对话框里找到，如图 3-46 所示。

图 3-46 查看自定义函数 

自定义的函数可以和其他函数嵌套使用，如图 3-47 所示。如：

```c
=Char(64+fun())
```

图 3-47 嵌套使用自定义函数 

在 VBA 过程中使用自定义函数 

在 VBA 中使用自定函数与使用 VBA 的内置函数一样，如图 3-48 所示。

图 3-48 在 VBA 中使用自定义函数 

3.9.3 怎么统计指定颜色的单元格个数 

问题一：单元格是什么颜色 

在 Excel 里，可以通过 RGB 函数指定不同的颜色，如想将活动工作表中 B1 单元格的底纹设置为黄色，代码为： 

```c
Range("B1").Interior.Color = RGB(255,255,0)
```

怎么统计指定颜色的单元格个数

```c
Function CountColor()
  If Range("A1").Interior.Color = RGB(255,255,0) Then
    Countcolor = 1
  Else
    Countcolor = 0
  End If
End Function
```

要知道 A1:A10 里有少个黄色单元格，可以让 VBA 替我们数一下，是黄色的累计，不是黄色的排除。在工作表里输入函数，可以看到函数返回的计算结果，如图 3-49 所示。

```c
Function CountColor()
  Dim rng As String
  For Each rng In Range("A1:A10")
    If rng.Interior.Color = RGB(255,255,0) Then
      Countcolor = Countcolor + 1
    End If
  Next rng
End Function
```

图 3-49 统计黄色单元格的个数 

还可以通过颜色索引号来引用某个颜色，在 Excel 2003 中，默认情况下，黄色的颜色索引号为 6，所以上面的代码还可以写为：

```c
Range("A1").Interior.Color = 6
```

ColorIndex 属性引用的是某个索引号上的颜色，而 Color 返回的是真实颜色。因为颜色的索引号可以更改，所以使用 ColorIndex 属性引用到的颜色不一定都相同，因此函数不一定能返回正确的结果。

用参数指定计算区域 

在工作表中使用函数时，可以通过函数参数指定计算统计的单元格区域。自定义函数也可以使用参数。如果需要统计的单元格区域不是固定的，可以用变量代替程序里的 A1:A10 单元格区域，让用户在使用自定义函数时通过函数参数指定区域。

```c
Function CountColor(arr As Range)
  Dim rng As Range
  For Each rng In arr
    If rng.Interior.Color = RGB(255,255,0) Then
      Countcolor = Countcolor + 1
    End If
  Next rng
End Function
```

为函数设置参数后，如果要统计 A1:C10 中黄色底纹单元格的个数，输入公式 `=countColor(A1:C10)` 即可，如图 3-50 所示。

图 3-50 使用参数的自定义函数 

给自定义函数指定第 2 参数 

还可以给函数设置第 2 参数，通过第 2 参数指定要统计的颜色。

```c
Function CountColor(arr As Range, c As Range)
  Dim rng As Range
  For Each rng In arr
    If rng.Interior.Color = c.Interior.Color Then
      Countcolor = Countcolor + 1
    End If
  Next rng
End Function
```

在工作表中使用自定义的函数，如图 3-51 所示。

图 3-51 用参数指定需要统计的颜色 

如果需要，还可以为函数添加第 3 参数，第 4 参数…… 

设置自定义函数为易失性函数 

有时，当工作表重新计算之后，自定义函数并不会重新计算。如在工作表中使用第 3 章 3.9.1 小节中生成随机的自定义函数后，按 F9 键重算工作表，函数并不会生成新的随机值。但如果在函数开始添加一条语句，添加语句后，无论何时重新计算工作表，函数都会重新计算，得到新的结果。

```c
Public Function Fun()
  Application.Volatile True
  Dim arr As Variant, txt As String
  Fun = Int(Rnd()*10) + 1
End Function
```

注意：使用 `Application.Volatile True` 语句是将自定义函数声明为易失性函数。当工作表发生重算后，易失性函数会重新计算函数的值。但因为更改单元格的背景颜色不会让工作表重算，所以，无论是否使用该语句，更改单元格的颜色后，本节中编写的自定义函数 CountColor 都不会重新计算。

3.9.4 声明函数过程，规范的语句 

声明 Function 过程的语句和声明 Sub 过程的语句类似。同 Sub 过程一样，Function 函数也分公共函数和私有函数，如果想声明一个私有函数，请一定要加上 Private 关键字。

### 3.10 合理地组织程序，让代码更优美 

编程就像做事，得讲究条理。先做什么，后做什么，安排好了，程序才不会改错。除了在操作上要有条理之外，也应尽量让代码条理清晰，便于阅读。所以，在编程时，除了要遵循 VBA 的语法规则外，还应养成一些良好的习惯。

3.10.1 代码排版，必不可少的习惯 

两篇同样的稿纸，是否经过精心排版，对读者的吸引力肯定不一样。要想让自己编写的程序清晰易懂，排版的过程也必不可少。图 3-52 所示为排版前后的代码。

图 3-52 排版前后的代码 

3.10.2 怎样排版代码 

缩进，让代码更有层次 

缩进可以使程序更容易阅读和理解，在 VBA 中，过程的语句要比过程名缩进一定的字符，在 If、Select Case、For…Next、Do…Loop、With 语句等之后也要缩进，一般缩进 4 个空格，如图 3-53 所示。

1『 VBA 的代码缩进一般是 4 格，跟 Python、PHP 一样。目前习惯缩进 2 格的语言有 JS、AutoLisp。做一张信息数据卡片。（2021-03-18）』—— 已完成

图 3-53 缩进的代码 

但在缩进某行或某块代码时，并不用手动在代码前敲入 4 个空格，可以选中代码块（如果是一行，只需将光标定位到行首而不用选中它），按下 Tab 键（或依次执行【编辑】→【缩进】菜单命令）即可将代码统一缩进一个 Tab 宽度，如图 3-54 所示。

图 3-54 利用菜单命令缩进代码块 

如果选中已缩进的代码，按 `<Shift+Tab>` 组合键（或依次执行【编辑】→【凸出】菜单命令），则将选中的代码取消缩进一个 Tab 宽度。Tab 宽度默认为 4 个空格，可以在【选项】对话框里修改如图 3-55 所示。

图 3-55 设置 Tab 宽度 

更改长行代码为短行代码 

当一条语句过长时，可以在句子的后面输入一个空格和下划线（`_`），然后换行，把一行代码分成两行。如： 

1『这里注意：换行是 `_` 前面的空格不能少。VBA 换行必须用 `_` 很不友好啊，其他语言都是直接换行了。（2021-03-24）』

虽然可以把一行代码分成两行、三行甚至更多，但盲目分行却不是好习惯，一般当一行代码的长度超过 80 个字符时，才考虑分行。把多行合并为一行 在第一行代码后加上英文冒号，可以接着写第二行代码。通过这样的方式可以把多行短代码合并成一行代码。尽管可以把多行代码写在同一行，但是这样会给阅读增加许多麻烦，所以除非必须需要，否则并不提倡这样做。

3.10.3 注释，让代码的意图清晰明了 

注释就像商品的说明书，介绍代码的功能及意图。编写的程序有什么用途，可以通过注释语句作简要介绍，让代码更加易读易懂。添加注释语句 注释语句以英文单引号开头，后面是注释的内容。可以放在代码的末尾，也可以单独写在一行，如图 3-56 所示。

图 3-56 为代码添加注释 

当注释语句单独成一行时，还可以使用 Rem 代替单引号。相信我，多数人不出 3 个月就会忘记自己写的程序代码的用途。所以，哪怕只是为自己，也应该为较为重要的代码添加注释。

妙用注释 

在调试程序时，如果不想运行某行代码，可以在代码前加上单引号（或 Rem），让它成为注释语句，而不用删除它。当要恢复这些代码时，只要将单引号（或 Rem）删除即可（如图 3-57 所示），这个技巧在调试代码时经常都会用到。

图 3-57 注释某句不需要的代码 

如果要注释或取消注释一块代码，还有简单的方法，如图 3-58 所示。

图 3-58 批量添加注释 

图 3-58 批量添加注释（续） 如果要取消注释，把代码还原成普通代码，就选中注释代码块，单击【编辑】工具栏中的【解除注释块】按钮，如图 3-59 所示。

图 3-59 批量取消注释