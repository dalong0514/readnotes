## 记忆时间

2021-04-20

## 0401. 常用对象

只会心法和招式，有力无处使；只有棒，不懂要诀，只会乱打一通，都是失败！ 编写 VBA 程序就像练打狗棒法。会心法和招式后，也要有根打狗棒才行。在 VBA 中，对象就是碧绿如玉的打狗棒，而语法就是心法和招式，教我们如何控制手中的打狗棒，耍出变化精微、招术奇妙的棒法来。在前面我们已经修炼了编程的心法和招式，下面就一起来学习如何使用「棒」吧。

### 4.1 与 Excel 交流，需要熟悉的常用对象

4.1.1 VBA 编程与炒菜 

菜是怎么炒出来的 

巧妇难为无米之炊，再聪明伶俐的媳妇只守着空灶台也煮不出香喷喷的饭菜，必须打开冰箱，取出瘦肉、葱、蒜…… 然后洗、切、炒，最后大勺一挥，一盘色香味美的鱼香肉丝才能摆上饭桌，如图 4-1 所示。

图 4-1 炒菜的步骤 

编程就如炒菜，盘子里的菜就是按炒菜的方法对材料进行加工写出的程序。VBA 编程需要的源材料就是 VBA 里的对象。想要编写 VBA 程序，首先要懂得如何打开「冰箱」，在「冰箱」里找到合适的东西，取出并加工它。这个「冰箱」在 Excel 里称为对象模型。

什么是对象模型 

就像厨房里的东西一样，Excel 中的对像总是层次分明地组织在一起，一个对象可以包含其他对象，也可以包含在其他对象里（参阅 3.4 节）。这种对象的排列模式称为对象模型。Excel 中的所有对象都可以在对象模型里找到。

怎么打开对象模型 

图 4-2 打开对象类型

1『上面这张图的价值很大，直接可以查看所有的 VBA 对象模型。在 VB 编辑器的帮助文档里。（2021-03-19）』

4.1.2 VBA 是怎么控制 Excel 的 

VBA 通过操作不同的对象来控制 Excel 

作为一个 Excel 用户，每天都在重复打开、关闭工作簿，输入、清除单元格内容的操作，这些操作都是在操作对象。是的，我们每天都在用动作编程。实际上，VBA 程序就是用代码记录下来的一个或一组操作。如想在 "Sheet1" 工作表的 A1 单元格输入数值 100，完整的代码为： 

```c
Application.Worksheets("Sheet1").Range("A1").Value = 100
```

1-2『

这里就收到了启发，之前开发了暖通的自动生成设备表，因为只是提取一个设备类型的设备（风机），提取的数据是当前「活动」表单里的。那么跟夏老板沟通时，他想在一个 excel 表里同时提取多个类型的设备数据，需要新建多个表单。目前的理解只要把上面代码里的 `Sheet1` 替换为对应的表单名，重构暖通那边的代码，是可以很方便提取多个表单数据的。不同的表单之前插入一条「假」数据（`,sheet,sheet,`）作为 lisp 那么的分割标签。（2021-03-19）

补充：突然想到更好的遍历方法。印象中最开始学的一个代码例子正好适合该场景。

```c
For Each sht In ThisWorkbook.Worksheets 
    myTxt.Write sht.Name & vbCrLf 
Next
```

那么用循环体里面用 `sht.Range` 替代原来的 `Range` 即可。（2021-03-20）

补充：第三章里讲解循序语句时有个代码可以借鉴。

```c
Sub shtname()
  Dim sht As Worksheet, i As Integer
  i = 1
  For Each sht In Worksheets
    Cells(i, "A") = sht.Name
    i = i +1
  Next sht
End Sub
```

多个表格还有一个实现方式：每个表格数据，每一行提取之前加一个「数据类型」的属性，提取所有数据后在其他地方，根据这个数据类型来做筛选分组。设备工程图提取数据采用的该思路。（2021-04-20）

```c
' 2021-04-19
Public Sub ExtractBsGCTDataToCSV()
  Dim fso As Object
  Dim myTxt As Object
  Dim MyFName As String
  Dim row As Integer, column As Integer
  
  MyFName = "D:\dataflowcad\bsdata\bsGCT.csv"
  
  Set fso = CreateObject("Scripting.FileSystemObject")
  Set myTxt = fso.CreateTextFile(Filename:=MyFName, OverWrite:=True)

  row = 1
  column = 1
  Do While Sheet1.Range("B2:U100").Cells(row, 1).Value <> ""
    myTxt.Write ",Tank"
    For column = 1 To 22
      myTxt.Write ","
      myTxt.Write Sheet1.Range("B2:U100").Cells(row, column).Value
      
    Next column
    myTxt.Write vbCr
    row = row + 1
  Loop

  ' Extract the nozzle data
  row = 1
  column = 1
  Do While Sheet2.Range("B3:H3000").Cells(row, 1).Value <> ""
  myTxt.Write ",nozzle"
    For column = 1 To 7
      myTxt.Write ","
      myTxt.Write Sheet2.Range("B3:H3000").Cells(row, column).Value
      
    Next column
    myTxt.Write vbCr
    row = row + 1
  Loop

  myTxt.Close
  Set myTxt = Nothing
  Set fso = Nothing
  MsgBox "Extract Sucess!"
End Sub
```

』—— 已完成

无论是用动作还是用代码，都是在操作对象。所以，编写 VBA 程序，就是利用 VBA 语句引用对象并有目的地操作它。

4.1.3 应该记住哪些对象 

VBA 编程就像炒菜 

菜市场的菜花样繁多，买菜时应该买什么？红烧鱼很香，但家里从来不吃，买菜时要不要买？ 买菜只买需要的，而不用买下整个菜市场。认识对象也是如此，并不用记住所有的对象，只需要熟悉它的结构和组成，记住经常的即可。对于那些不常用或根本不会用到的，只要在需要用到时能熟悉打开帮助菜单，像查字典一样找到它就够了。偶尔那么一天，忽然想吃红烧鱼了，出门打个的，告诉司机：「菜市场！」一去一来，十五分钟，搞定！ 

应该记住哪些常用的对象 

不买的菜坚决不买，要买的也千万不要落下。菜市场，一去一来，十五分钟，的确不远。但是菜洗好了，发现没有买油，然后出门打的…… 十五分钟后，炒菜炒到一半，却发现没有买辣椒，于是，再一次出门打的…… 又十五分钟后，菜快炒好了，忽然发现没有买葱…… 最后的最后，鱼香肉丝终于端上了餐桌。来之不易的饭菜，真不简单。存在冰箱里的当然是生活常用品。学习 VBA，需要记住哪些常用的对象？想一想，日常工作中经常会操作哪些对象（见表 4-1）。

表 4-1 Excel VBA 常用的对象     

| 对象 | 对象说明 |
| --- | --- |
| Application | 代表 Excel 应用程序 |
| Workbook | 代表 Excel 中的工作簿，一个 Workbook 对象代表一个工作簿文件 |
| Worksheet | 代表 Excel 中的工作表，一个 Worksheet 对象代表工作簿里的一张普通工作表 |
| Range | 代表 Excel 中的单元格，可以是单个单元格，也可以是单元格区域 |

### 4.2 一切由我开始，最顶层的 Application 对象

打开对象模型，最顶端的 Application 对象是起点，它代表 Excel 程序本身，就像一棵树的根，Excel 里所有的对象都以它为起点，生根发芽，开枝散叶。实际编程时，会经常用到它的许多属性和方法。

4.2.1 ScreenUpdating 属性 

一个小故事 

新来的老师站在讲台上，手指窗户边：「喂，那个边上的同学…… 对，就是你，头大的那位男孩，起来回答个问题。」大头儿子，班上的学习委员，老师真会挑。「38 加 25。」「63，」不假思索就回答了。「再减 15。」「48。」「再减 36。」「12。」…… 五年级的学生，二年级的问题，大头儿子有些不服气。「老师，你能不能一次说完，我算有 10 步运算的。」老师：「……」如果不需要中间的结果，计算时把计算过程记在心里。大头儿子说：「我很喜欢这样的问答方式。」

Excel 里天天都在多步提问 

在用 Excel 处理数据时，需要做的操作往往不只是一步。上述代码执行的过程如图 4-3 所示。

```c
Public Sub InputTest()
  Cells.ClearContents
  Range("A1:A10") = 100
  Range("B1:B10") = 200
End Sub
```

1-2『这里收获到清除表格中所有数据的实现 `Cells.ClearContents`。这个方法收录进主题卡「VBA 对象常用对象方法」。（2021-03-19）』—— 已完成

图 4-3 程序的执行过程 

不显示计算结果到屏幕上 

同样的程序，稍加修改后，再一次执行它，观察它的运行过程，如图 4-3 所示。

```c
Public Sub InputTest()
  Cells.ClearContents
  Application.ScreenUpdating = False
  Range("A1:A10") = 100
  Range("B1:B10") = 200
  Application.ScreenUpdating = True
End Sub
```

图 4-4 程序的执行过程 2 

练习小课堂：对比两个程序的执行过程，你发现它们之间的区别了吗？设置 ScreenUpdating 属性有什么作用？试着小结一下。

参考答案：区别在于是否将程序运行过程中的计算结果显示到屏幕上。设置 ScreenUpdating 属性为 False，将看不到程序的执行过程，可以加快程序的执行速度，让程序显得直观、专业。

4.2.2 DisplayAlerts 属性 

烦人的删除工作表 

这是一个删除工作表的小程序： 

```c
Public Sub DelSht()
  Dim sht As Worksheet
  For Each sht In Worksheets
    If sht.Name <> ActiveSheet.Name Then
      sht.Delete
  Next
End Sub
```

但是，程序运行后并不顺畅，如图 4-5 所示。

图 4-5 删除工作表前的警告对话框 

取消显示警告对话框 

如果想取消显示对话框，只需要对程序作简单的修改： 

```c
Public Sub DelSht()
  Dim sht As Worksheet
  Application.DisplayAlerts = False
  For Each sht In Worksheets
    If sht.Name <> ActiveSheet.Name Then
      sht.Delete
  Next
  Application.DisplayAlerts = True
End Sub
```

1『发现了，修改这些系统属性后记得都改回默认值，这是个好习惯。（2021-03-19）』

修改完成后，再次运行程序，警告对话框彻底消失了。

DisplayAlerts 属性，详细的介绍 

Application 对象的 DisplayAlerts 属性决定在程序运行中是否显示警告信息，默认值为 True，如果不想在程序运行时被提示和警告信息打扰，可在程序开始时将属性设为 False。但如果在程序中修改了该属性为 False，在程序结束前请记得将它设回 True。

4.2.3 EnableEvents 属性 

可以通过设置 Application 对象的 EnableEvents 属性来启用或禁用事件。

什么是事件 

事件是能被 Excel 认识的一个操作动作（参阅 5.1.2 小节）。Excel 里的许多操作都会触发事件，如打开工作簿、关闭工作簿等。用户可以编写不同的代码来响应这些事件，当触发某个事件时，自动执行指定的代码。

自动写入单元格地址 

编写一个程序，当选中工作表中的单元格时，自动在单元格中写入该单元格的地址，如图 4-6 所示。

图 4-6 在工作表对象中输入程序

```c
Private Sub Worksheet_SelectChange(ByVal Target As Range)
  Target.Value = Target.Address
End Sub
```

1-2『

单元格的地址。这个对象属性收录进主题卡「VBA 对象常用对象属性」。`Target As Rang` 语句，Target 变量代表用户当前选择的单元格。（2021-03-19）

补充：这里还有个知识点，传参的时候如何把一个单元格或表格对象直接传递给子程序（或函数）。（2021-04-20）

』—— 已完成

完成后返回该工作表区域，选中任意一个单元格，Excel 会自动将该单元格的地址写入单元格中，如图 4-7 所示。

图 4-7 自动填写单元格地址 

这个程序是 `Worksheet_SelectionChange` 事件的应用，当用户更改选中的单元格时，自动运行 Sub 与 End Sub 之间的代码。

什么是禁用事件 

禁用事件就是执行操作后不让事件发生。如果禁用了事件，更改选中的单元格，Sub 与 End Sub 之间的代码并不会运行。在 VBA 里，可以设置 Application 对象的 EnableEvents 的属性为 False 来禁用事件。

练习小课堂：程序 1 和程序 2 是几乎完全相同的两个程序，用图 4-6 所示的方式将两个程序输入到不同的工作表对像中，然后分别在两张工体表中选中不同的单元格，看看程序运行的效果有什么不同？ 

参考答案：运行程序 1，程序将陷入死循环，无法得到预想的结果。执行程序 2 后，能得到预期的结果。设置 EnableEvents 属性为 False 后，当选中单元格后，Excel 不会再自动运行程序，即禁用了该事件。通过对比，你知道 EnableEvents 属性有什么作用吗？把自己的心得写下来。

1『看到这里，才意识到 Sub 名称 `Worksheet_SelectionChange` 是 VBA 中事件的名称。（2021-03-19）』

4.2.4 WorksheetFunction 属性

没有这样的函数，真遗憾 

VBA 里有许多内置函数可供使用，但在实际应用中，并不是所有的问题都能找到合适的函数来解决。如想统计 `A1:B50` 单元格中数值大于 1000 的单元格有多少个，就没有现成的函数，需要编写 `Function` 或 `Sub` 过程来统计。

```c
Public Sub CountTest()
  Dim mycount As Integer, rng As Range
  For Each rng In Range("A1:B50")
    If rng.Value > 1000 Then 
      mycount = mycount + 1
  Next
  MsgBox "A1:B50 中大于 1000 的单元格个数为：" & mycount
End Sub
```

2『收录进主题卡「VBA 对象属性」中。（2021-03-19）』—— 已完成

为什么不使用 COUNTIF 函数 

因为 VBA 里没有 COUNTIF 函数。其实不只 COUNTIF，SUMIF、TRANAPOSE、VLOOKUP 等常用函数在 VBA 中也没有。虽然 VBA 里没有这些函数，但并不意味着它们都不能在 VBA 中使用。在 VBA 里，可以使用 Appplication 对象的 `WorksheetFunction` 属性调用部分工作表函数。这个问题，也可以使用工作表中的 COUNTIF 函数来完成。

```c
Public Sub CountTest()
  Dim mycount As Integer, rng As Range
  mycount = Application.WorksheetFunction.CountIf(Range("A1:B50"), ">1000")
  MsgBox "A1:B50 中大于 1000 的单元格个数为：" & mycount
End Sub
```

注意： 如果 VBA 里已经有了相同的函数，不能再引用工作表中的函数，否则会出错。如要使用 Len 函数计算 "ABCDE" 的长度，应该写成 Len("ABCDE")，而不能写成 Application.WorksheetFunction.Len("ABCDE")。

4.2.5 给 Excel 梳妆打扮 

Excel 就像一个漂亮的姑娘，你可以随心所欲地打扮她。梳个漂亮的发型，画一画眉毛，换一件漂亮的衣服…… 小女孩的脸上有鼻子、眼睛、嘴巴等五官，Excel 的脸上也有「五官」，如图 4-8 所示。

图 4-8 Excel 的界面 如果你不想看到她的某个「器官」，可以把它隐藏起来，如果你觉得她的单眼皮不好看，可以动手改造一下（参阅 6.5 节）。

练习小课堂：

1、可以设置 Application 对象的某些属性来更改 Excel 的界面。运行 Excel 程序，进入 VBE，在立即窗口里运行表 4-2 中的每句代码，然后把看到的结果写下来。

表 4-2 

| 在【立即窗口】中输入代码 | 修改区域 | 代码执行后的效果 |
| --- | --- | --- | --- |
| Application.Caption = "我的 Excel" | 标题栏 | - | - |
| Application.Caption = "Microsoft Excel" | 标题栏 | - | - |
| Application.DisplayFormulaBar = False  | 编辑栏 | - | - |
| Application.DisplayStatusBar = False  | 状态栏 | - | - |
| Application.StatusBar = "正在计算，请稍候……" | 状态栏 | - | - |
| Application.StatusBar = False | 状态栏 | - | - |
| ActiveWindow.DisplayHeadings = False |  行标和列标 | - | - |

2、可以更改的项目很多，如果你不知道该用什么代码，别忘记使用录制宏功能。手动完成并录下表 4-3 列出的操作，然后将相应的代码填在表格里。

表 4-3 

| 代码执行后的效果 | 代码 |
| --- | --- |
| 隐藏工作表标签 | ActiveWindow.DisplayWorkbookTabs = False |
| 隐藏水平滚动条 | ActiveWindow.DisplayHorizontalScrollBar = False |
| 隐藏垂直滚动条 | ActiveWindow.DisplayVerticalScrollBar = False  |
| 显示绘图工具栏 | Application.CommandBars ("Drawing").Visible = False  |
| 隐藏常用工具栏 | Application.CommandBars ("Standard").Visible = False |
| 隐藏网格线 | ActiveWindow.DisplayGridlines = False  |

4.2.6 她和她的孩子们 

把对象模型这本家谱打开，Application 是家族的起点，开枝散叶，不同的孩子住在不同的地方。可以通过引用 Application 对象的属性返回不同的子对象。所以，引用对象必须把每一级的对象名称写清楚。如：

引用 Application 的每一个子对象都可以使用这种引用方式，但对于某些特殊的对象却不必这么严谨，如想在当前选中的单元格里输入数值 300，因为「选中的单元格」是一个特殊的对象，所以代码可以写为： 

```c
Application.Selection.Value = 100
```

1『这里的 `Selection` 表示当前选中的对象。（2021-03-19）』

Application 可以省略不写，直接将式码写为： 

```c
Selection.Value = 100
```

除了 `Selection`，还可以使用其他属性引用某些特殊对象，如表 4-4 所示。

表 4-4　

| Application 的常用属性 | 说明 |
| --- | --- |
| ActiveCell | 当前活动单元格 |
| ActiveChart | 当前活动工作簿中的活动图表 |
| ActiveSheet | 当前活动工作簿中的活动工作表 |
| ActiveWindow | 当前活动窗口 |
| ActiveWorkbook  | 当前活动工作簿 |
| Charts | 当前活动工作簿中所有的图表工作表 |
| Selection | 当前活动工作簿中所有选中的对象 |
| Sheets | 当前活动工作簿中所有 Sheet 对象，包括普通工作表、图表工作表、Ms Excel 4.0 宏表工作表和 Ms Excel 5.0 对话框工作表 |
| Worksheets | 当前活动工作簿中的所有 Worksheet 对象（普通工作表） |
| Workbooks | 当前所有打开的工作簿 |

2『上面的对象属性收录进主题卡「VBA 对象属性」。（2021-03-19）』—— 已完成

### 4.3 管理工作簿，了解 Workbook 对象 

4.3.1 Workbook 与 Workbooks 

什么是 Workbooks 

就像英语里的可数名词，Workbook 代表一个工作簿，加 s 后的 Workbooks 表示当前打开的所有工作簿，即工作簿集合（参阅 3.4.1 小节）。

怎么引用单个工作簿 

引用工作簿，就是指明工作簿的位置及名称。体育老师嘴里的「同学」是一个笼统的称呼，是所有同学的集合，谁该去示范呢？同学们都很迷茫，因为老师没有使用正确的引用方式指明同学的身份。引用工作簿，指明了工作簿的身份，VBA 才知道应该操作谁。引用工作簿常用的方法有两种。

方法一： 利用索引号引用工作簿 

同数组里元素的索引号（参阅 3.3.4 小节）类似，索引号指明一个工作簿在工作簿集合里的位置，如图 4-9 所示。

图 4-9 工作簿的索引号 

操场上，同学们整整齐齐地排成一队，张姣排在第 3 位。老师：「第 3 个同学，出列！」，大家都知道，叫的是张姣。如果要引用 Workbooks 集合里的第 3 个 Workbook，可以使用代码： 

```c
Workbooks.Item(3)
```

可以省略 Item，直接简写为： 

```c
Workbooks(3)
```

方法二： 利用工作簿名引用工作簿 

第一次排队，张姣站在第 3 位，第二次排队，站在第 8 位。如果老师一直在那嚷嚷：「3 号出列！」还能把她叫出来吗？ 这时候，更适合的做法应该是叫同学的名字：「张姣，到你演示了。」引用工作簿也如此，如果不能确定索引号，使用工作簿的名称引用会更准确一些。如想引用 "Book1" 工作簿，代码为： 

```c
Workbooks("Book1")
```

可以给工作簿的文件加上扩展名，写成： 

```c
Workbooks("Book1.xls")
```

练习小课堂：新建一个工作簿，在不保存的情况下，打开【立即窗口】，分别运行代码： 

试一试，都能运行吗？在一个已经保存的工作簿（文件名称为 "Book1.xls"）中。想一想，什么时候可以使用扩展名，什么时候不能使用扩展名？把你的总结写下来。

参考答案：1）如果是新建的工作簿，在不保存（即该文件不存在）的情况下，引用时不能加扩展名；2）如果是已经存在的文件，当系统设置不显示文件的扩展名时，引用时可以使用扩展名，也可以不使用；3）如果是已经存在的文件，当系统设置显示文件的扩展名时，引用时必须使用扩展名。所以，对于一个已经存在的文件，使用带扩展名的名称引用它会准确一些。

1『不错不错，可以的话尽量带扩展名。（2021-03-19）』

4.3.2 认识 Workbook，需要了解的信息 

想了解它，就替它做张名片 

Excel 就像一个美丽的美眉，想和她交朋友，必须掌握她的基本信息，如图 4-10 所示。

图 4-10 名片上人物的信息 

要了解 Workbook，也可以做一张名片记录它的基本信息，如图 4-11 所示。

图 4-11 等待完善的工作簿名片 

填写这张名片的信息，可以读取 Workbook 对象的 Name 属性、Path 属性和 FullName 属性值，如图 4-12 所示。

图 4-12 完善后的名片

```c
Public Sub WbMsg()
  Range("B2") = ThisWorkbook.Name
  Range("B3") = ThisWorkbook.Path
  Range("B4") = ThisWorkbook.FullName
End Sub
```

1『这里知道了如何获取当前打开的 Excel 的路径。收录进主题卡「VBA 对象方法」。（2021-03-19）』—— 已完成

让名片更详细 

Workbook 对象拥有很多的属性和方法供你将名片完善，想知道它有哪些属性或方法，可以在帮助里查看，如图 4-13 所示。

图 4-13 Workbook 对象的帮助 

4.3.3 实际操作，都能做什么 

创建一个工作簿文件

```c
Workbooks.Add
```

可以给 Add 方法设置参数： 

```
Workbooks.Add("C:\dalong.xls")
```

也可以通过参数指定新建工作簿中包含的工作类型： 

```c
Workbooks.Add xlWBATCHart
```

1『上面的代码表示，新建的工作簿包含一张图表工作表。（2021-03-19）』

Excel 一共有 4 种类型的工作表，可以在【插入】对话框里看到，如图 4-14 所示。

图 4-14 Excel 中 4 种类型的工作表 

如果想让新建的工作簿包含指定类型的工作表，可以使用 xlWBATCHart、xlWBATExcel4lntlMacroSheet、xlWBATExcel4MacroSheet 或 XlWBATWorksheet 作为参数，如图 4-15 所示。

图 4-15 4 种不同工作表对应的参数 

打开工作簿 

打开一个 Excel 文件，最简单的方法就是使用 Workbooks 的 Open 方法。

```c
Public Sub OpenFile()
  Workbooks.Open FileName:="D:\Book1.xls"
End Sub
```

参数名称可以省略不写： 

```c
Workbooks.Open "D:\Book1.xls"
```

除了 Filename 参数，Open 方法还有 14 个参数，让用户决定以何种方式打开指定的文件，可以通过系统的帮助来了解更多的信息。

2『打开工作簿，做一张任意卡片。（2021-04-20）』—— 已完成

激活工作簿 

打开了 5 个工作簿文件，但同一时间只能有一个窗口是活动的。调用 Workbooks 对象的 Activate 方法可以激活一个工作簿。

```
Workbooks("Book1").Active
```

保存工作簿 

保存工作簿就调用 Workbook 对象的 Save 方法。

如果想将文件另存为一个新的文件，或者是第一次保存一个新建的工作簿，就用 SaveAs 方法。

```c
ThisWorkbook.SaveAs FileName:="D:\Book1.xls"
```

使用 SaveAs 方法将工作簿另存为新文件后，将自动关闭原文件，打开新文件，如希望继续保留原文件不打开新文件，可以用 SaveCopyAs 方法。

关闭工作簿 

```c
Workbooks.Close
```

如果想关闭指定的某个工作簿文件，应用代码指定。

```
Workbooks("Book1").Close
```

如果工作簿被更改过而且没有保存，关闭工作簿前 Excel 会询问用户是否保存更改，如图 4-16 所示。

图 4-16 是否保存工作簿的对话框 

如果不想显示该对话框，可以给 Close 方法设置参数： 

```c
Public Sub CloseWb()
  Workbooks("Book1").Close savechanges:=True 
End Sub
```

4.3.4 ThisWorkbook 与 ActiveWorkbook 

同是 Application 对象的属性，同是返回 Workbook 对象，但二者并不是等同的。ThisWorkbook 是对程序所在工作簿的引用，ActiveWorkbook 是对活动工作簿的引用。打开一个工作簿，在工作簿中输入并运行下面的程序，查看程序运行的结果，如图 4-17 和图 4-18 所示。

图 4-17 ThisWorkbook 

图 4-18 ActiveWorbook

### 4.4 操作工作表，认识 Worksheet 对象 

4.4.1 认识 Worksheet 对象 

Worksheet 与 Worksheets 

一个 Worksheet 对象代表一张普通工作表，Worksheets 是多个 Worksheet 对象的集合，包含指定工作簿中所有的 Worksheet 对象。

引用工作表 

可以使用工作表的索引号或标签名称引用它，如图 4-19 所示。

图 4-19 工作表的索引号和标签名称 

1『发现了，根据索引去获取工作簿或工作表对象，索引号都是对应于打开的先后顺序。（2021-03-20）』

如图 4-17 所示，如果要引用第 1 张工作表，可以选用以下 3 条语句中的其中 1 条： 

```c
Worksheets.Item(1)
Worksheets(1)
Worksheets("Sheet1")
```

除此之外，还可以使用工作表的代码名称引用工作表。工作表的代码名称可以在【工程资源管理器】或【属性窗口】中看到，如图 4-20 所示。

图 4-20 工作表的代码名称和标签名称

1-2『这里才意识到，工作表的代码名称 `Sheet` 跟外面自己重命名的名称是不一样的，它是 Worksheet 对象的属性名，需要在属性窗口里改。这里「引用工作表」的实现做一张任意卡片。（2021-03-20）』—— 已完成

因为代码名称只能在【属性窗口】里修改，不会随工作表标签名称或索引号的变化而变化。因此，当工作表的索引号或标签名称经常变化时，使用代码名称引用工作表会更方便。使用代码名称引用工作表，只需直接写代码名称。如在图 4-20 中的「第一张工作表」的 A1 单元格输入 10，代码为： 

```c
Sheet1.Range("A1") = 100
```

查看工作表的代码名称，可以读取它的 CodeName 属性，如果想知道活动工作表的代码名称，代码为： 

```c
Public Sub ShowShtCode()
  MsgBox ActiveSheet.CodeName
End Sub
```

4.4.2 操作工作表 

新建工作表 

使用 Worksheets 对象的 Add 方法：

```c
Worksheets.Add
```

可以用参数给新建的工作表指定位置：

```c
' 在第一张工作表前插入一张新工作表
Worksheets.Add before:=Worksheets(1)
' 在第一张工作表后插入一张新工作表
Worksheets.Add after:=Worksheets(1)
```

还可以同时插入多张工作表： 

```c
' 在活动工作表前插入 3 张工作表
Worksheets.Add Count:=3
```

编写程序时，可以同时使用多个参数： 

```c
' 在第一张工作表后插入 3 张新工作表
Worksheets.Add after:=Worksheets(1), Count:=3
```

练习小课堂：试一试，在当前工作簿中最后一张工作表前插入两张工作表，你能做到吗？把你的程序写下来。

参考答案：

```c
Worksheets.Add before:=Worksheets(Worksheets.Count), Count:=2
```

更改工作表标签名称 

如果你想更改工作表的标签名称，就设置它的 Name 属性： 

```c
Worksheets(2).Name = "工资表"
```

如果是新建的工作表，可以在程序中更改： 

```c
Worksheets.Add before:=Worksheets(1)
ActiveSheet.Name = "工资表"
```

也可以在新建工作表的同时指定它的标签名称： 

```c
Worksheets.Add (before:=Worksheets(1)).Name = "工资表"
```

但如果同时添加多张工作表（即 Count 参数值大于 1 时），并不能使用一句代码同时命名。

Add 方法有哪些参数 

在【代码窗口】中，输入完对象的方法名称后按空格，VBE 会自动显示该方法的所有参数，用户可以根据提示进行输入，如图 4-21 所示。

图 4-21 输入 Add 方法时的提示 

删除工作表 

使用 Worksheet 对象的 Delete 方法可以删除指定的工作表。

练习小课堂：删除工作表时，会弹出一个询问的警告对话框。想取消显示它，还记得用什么方法吗（参阅 4.2.2 小节）？编写一个删除「工资表」的 Sub 过程，你能做到吗？ 

参考答案：

```c
Application.DisplayAlerts = False
Worksheets("工资表").Delete
Application.DisplayAlerts = True
```

激活工作表 

激活工作表就是让处于不活动状态的工作表变为活动工作表。激活工作表可以用 Activate 方法和 Select 方法。

```c
Worksheets(1).Activate
Worksheets(1).Select
```

练习小课堂：

1、按步骤操作，把你得到的结论写出来： 

Step 1：隐藏工作簿中的第一张工作表，试一试用下面的两种方法激活它，能完成吗？ 

Step 2：试一试用下面的两种方法同时选中工作簿中的所有工作表，能完成吗？ 

2、你知道使用 Select 和 Activate 两种方法的区别吗？把你的结论写下来。

参考答案：当工作表隐藏时，调用它的 Select 会出错。用 Activate 方法不用同时选中多张工作表，但用 Select 方法可以同时选中未隐藏的多张工作表。

复制工作表 

使用 Copy 方法可以复制工作表，如图 4-22 所示。

```c
Worksheets("工资表").Copy before:=Worksheets("出勤登记表")
```

图 4-22 复制工作表 

如果不使用参数，默认将工作表复制到新工作簿中，如图 4-23 所示。

图 4-23 不使用参数复制工作表 

练习小课堂：

1、使用参数和不使用参数时，复制的工作表名称一样吗？如果想把「工资表」复制到「出勤登记表」前，更名为「工资表备份」，你知道完整的程序应该怎样写吗？试一试，写下来。

2、动手写一个程序，将「工资表」复制到新工作簿中，工作表名为「工资表备份」，同时将文件保存到 D 盘根目录下，文件名称为「7 月工资表.xls」，要求保存工作簿后，原工作簿仍可以操作。    

参考答案：

1、使用参数复制工作表时，将把工作表复制到同一工作簿中，Excel 自动为工作表命名，与原工作表不同。不使用参数复制工作表时，将把工作表复制到新工作簿中，名称与原来相同。

2、代码：

```c
Public Sub ShtCopy()
  Worksheets("工资表").Copy
  ActiveSheet.Name = "工资表备份"
  ActiveWorkbook.SaveCopyAs "D:\工资备份.xls"
  ActiveWorkbook.Close False
End Sub
```

移动工作表 

移动工作表的操作与复制工作表类似。

隐藏或显示工作表 

可以设置工作表的 Visible 属性显示或隐藏该工作表，如图 4-24 所示。

图 4-24 通过属性窗口隐藏或显示工作表

```c
Worksheets("工资表").Visible = False
Worksheets("工资表").Visible = xlSheetHidden
Worksheets("工资表").Visible = 0

Worksheets("工资表").Visible = xlSheetVeryHidden
Worksheets("工资表").Visible = 2
```

无论以何种方式隐藏了「工作表」工作表，想用代码显示它，可以用下面 4 句代码中的任意一句： 

```c
Worksheets("工资表").Visible = True
Worksheets("工资表").Visible = xlSheetVisible
Worksheets("工资表").Visible = 1
Worksheets("工资表").Visible = -1
```

获取工作表的数目 

想知道当前工作簿中共有几张工作表，可以读取 Worksheets 的 Count 属性值，运行结果如图 4-25 所示。

图 4-25 求工作表数量 

4.4.3 Sheets 与 Worksheets 

有人说，它们相同。有人说，Sheets 同 Worksheets 没有区别，如图 4-26 所示。

图 4-26 在立即窗口中执行命令 

但是，它们相同吗？其实 Sheets 与 Worksheets 代表两种不同的集合。Excel 里一共有 4 种不同类型的工作表，Sheets 表示工作簿里所有类型的工作表的集合，而 Worksheets 只表示普通工作表的集合，如图 4-27 所示。

图 4-27 Sheets 与 Worksheets 集合的区别 

练习小课堂：试一试，在工作簿中插入不同类型的工作表后，在【立即窗口】中执行下面的代码，返回的值还相同吗？ 

参考答案：Sheets.Count 返回各种类型的工作表的数量之和，Worksheets.Count 返回普通工作表的数量。

关于 Sheets 与 Worksheets 

Sheets 与 Worksheets 集合里的对象都有标签名称（Name），代码名称（CodeName）、索引号（index）等属性，也都有 Add、Delete、Copy 和 Move 等方法，设置属性或调用方法的操作类似。但因为 Sheets 集合包含更多类型的工作表，所以其包含的方法和属性比 Worksheets 集合多。

### 4.5 核心，至关重要的 Range 对象

Range 对象代表工作表中的单元格或单元格区域，包含在 Worksheet 对象中。

4.5.1 多种方法引用 Range 对象 

操作单元格，需要先引用单元格。信封上的收信地址，告诉邮递员应该把信投到哪家邮箱。只有写清楚地址，信才不会寄错。引用单元格，就像写在信封上的地址，如果要把某商品的销售数量 50 保存到活动工作簿中 Sheet1 工作表的 A1 单元格中，代码为： 

这里的 Range ("A1") 就是引用 A1 单元格的一种形式。在 VBA 里，引用单元格有多种方法。

Worksheet（或 Range）对象的 Range 属性 

如果单元格已经被定义为名称，参数还可以是表示名称名的字符串或字符串变量，如图 4-28 所示。

图 4-28 定义的名称 

如果要引用多个不连续的区域，可以在各区域间添加逗号，如图 4-29 所示。

```c
Sub rng()
  Range("A1:A10, A4:E6, C3:D9").Select
End Sub
```

图 4-29 引用多个不连续区域 

如果想引用相交区域（公共区域），可以在多个区域间添加空格，如图 4-30 所示。

```c
Sub rng()
  Range("B1:B10 A4:D6").Select
End Sub
```

图 4-30 引用相交区域 

还可以使用两个参数来引用两个区域围成的矩形区域，如图 4-31 所示。

```c
Sub rng()
  Range("B1:B10", "D2:D8").Select
End Sub
```

图 4-31 使用两个参数引用单元格 

Worksheet（或 Range）对象的 Cells 属性 

这是引用 Range 对象的另一种形式，返回指定工作表或单元格区域中指定行与列相交的单元格。如果引用的是 Range 对象的 Cells 属性，将返回指定单元格区域中指定行与列相交的单元格，如图 4-32 所示。

```c
Sub cel()
  ActiveSheet.Cells(3, 4).Value = 20
End Sub

Sub cel()
  ActiveSheet.Cells(3, "D").Value = 20
End Sub

Sub cel()
  Range("B3:F9").Cells(2, 3).Value = 20
End Sub
```

图 4-32 引用 Range 对象的 Cells 属性 

Cells 属性还可以用作 Range 属性的参数： 

```c
Sub cel()
  Range(Cells(1, 1), Cells(10, 5)).Value = 20
End Sub
```

Cells 可以只使用一个参数： 如果引用的是 Worksheet 对象的 Cells 属性，在 Excel 2003 中索引号的值为 1 到 16777216（65536 行 × 256 列）。单元格按从左往右，从上到下的顺序编号，即 A1 为第 1 个单元格，B1 为第 2 个单元格，C1 为第 3 个单元格……A2 为第 257 个单元格…… 如图 4-33 所示。

2『 Excel 单元格的总个数，做一张信息数据卡片。（2021-04-20）』—— 已完成

图 4-33 工作表中单元格的索引号 

如果引用的是 Range 对象的 Cells 属性，索引号的范围为 1 到这个单元格区域包含的单元格的个数。但索引号可以大于单元格区域里的单元格个数，如果索引号大于单元格个数，系统会自动将单元格区域在行方向上进行扩展（列数不变），然后再引用，如图 4-34 所示。

图 4-34 当索引号大于单元格个数时 

如果不使用任何参数，Cells 属性将返回指定对象中的所有单元格： 

练习小课堂：试一试，能用 Worksheet 对象的 Cells 属性引用 A1:B10 单元格区域吗？用 Range 属性和 Cells 属性引用单元格的区别是什么，你发现了吗？总结一下，并写下来。

参考答案：使用 Cells 属性只能引用一个单元格，不能引用多个单元格。

更简短的快捷方式 

如果想引用某个单元格或单元格区域，可以直接将单元格地址（A1 样式）写在中括号里。如果单元格或单元格区域已被定义为名称，也可以直接把名称名写在中括号里： 

```c
Sub cel()
  [B2]
  [A1:D10]
  [A1:A10, C1:C10, E1:E10]
  [B1:B10 A5:D5]
  [n]
End Sub
```

[] 是 Application 对象的 Evaluate 方法的简写形式，这种简写形式非常适合引用一个固定的 Range 对象。但是因为不能在方括号中使用变量，所以这种引用方式缺少灵活性。

4.5.2 还可以怎样得到单元格 

引用整行 

如果引用的是 Range 对象的 Rows 属性，则返回单元格区域里的指定行，如图 4-35 所示。

图 4-35 引用单元格区域里的指定行 

引用整列 

引用整列时参数可以是列标，也可以是索引号。

练习小课堂：根据提示，将表 4-5 中的代码补充完整。

表 4-5 补充代码     

| 提示 | 代码 |
| --- | --- |
| 用两种引用方式引用活动工作表的 B 列 | - |
| 引用活动工作表中的 B 列到 D 列 | - |
| 引用 B 列到 E 列区域中的第 2 列 | - |

参考答案：

Application 对象的 Union 方法 

Union 方法像一支强烈的粘合剂，将不连续的多个单元格区域粘在一起，可以同时对其进行操作，如图 4-36 所示。

```c
Sub RngUnion()
  Application.Union(Range("A1:A10"), Range("D1:D5")).Select
End Sub
```

1-2『

上面的「粘合」代码等同于：

```c
Sub rng()
  Range("A1:A10", "D1:D5").Select
End Sub
```

Union 方法补充进主题卡片「VBA 对象常用对象方法」。

』—— 已完成

图 4-36 使用 Union 方法选中两个不连续的单元格区域 

练习小课堂：表 4-6 中是一个未完成的程序，请根据代码说明将程序补充完整。让程序运行后，选中活动工作表中 A1:D10 单元格区域里与 A1 单元格内容相同的所有单元格，如图 4-37 所示。

图 4-37 程序执行效果图 

表 4-6 

参考答案：

Range 对象的 Offset 属性

「牛头市同兴路 2 号张大明转张姣（收）」，张姣是张大明的堂妹，写信的人不知道她家住哪里，所以让张大明转交。这是写地址的另一种方式。就像寄信一样，如果想把 500 保存到 A1 单元格的某个邻居（单元格）里，可以利用 Range 对象的 Offset 属性。从 A1 单元格出发，先向下移动 2 行，再向右移动 3 列，到达的单元格就是要保存数据的地方，如图 4-38 所示。

图 4-38 Offset 属性 

修改 Offset 的参数可以控制移动的方向和距离。如果参数是正数，表示向下或向右移动，如图 4-33 所示；如果参数为负数，表示向上或向左移动；如果参数为 0，则不移动，如图 4-39 所示。

图 4-39 利用 Offset 属性的参数控制偏移的方向和距离 

Range 对象的 Resize 属性 

使用 Range 对象的 Resize 属性扩大或缩小指定的单元格区域，得到一个新的单元格区域，如图 4-40 和图 4-41 所示。

图 4-40 使用 Resize 属性扩大单元格区域 

图 4-41 使用 Resize 属性收缩单元格区域 

Worksheet 对象的 UsedRange 属性 

UsedRange 是 Worksheet 对象的属性，返回工作表中已经使用的单元格围成的矩形区域，如图 4-42 所示。

图 4-42 使用 UsedRange 属性返回 Range 对象 

UsedRange 属性返回的工作表中所有已经使用的单元格围成的矩形区域，而不管这些区域间是否有空行、空列或空单元格，如图 4-43 所示。

图 4-43 使用 UsedRange 属性返回 Range 对象 

Range 对象的 CurrentRegion 属性 CurrentRegion 属性返回当前区域，即以空行和空列的组合为边界的区域，如图 4-44 所示。

图 4-44 使用 CurrentRegion 属性返回 Range 对象 

练习小课堂：通过对比，你能指出 Worksheet 的 UsedRange 属性与 CurrentRegion 属性之间的异同吗？试着总结一下。

参考答案：UsedRange 属性返回指定工作表中已使用的单元格围成的矩形区域，而不管该区域中是否有空行、空列或空单元格；CurrentRegion 属性返回当前区域，这个区域总是小于或等于 UsedRange 属性返回的区域。

Range 对象的 End 属性 

End 属性返回当前区域结尾处的单元格，等同于在源单元格按 <End + 方向键（上、下、左、右）> 得到的单元格，如图 4-45 所示。

图 4-45 使用 End 属性 

End 属性的参数一共有 4 个可选项，如表 4-7 所示，效果如图 4-46 所示。

表 4-7 End 属性的参数及说明     

| 参数 | 说明 |
| --- | --- |
| xlToLeft | 向左移动，等同于在源单元格 <按 Ctrl + 左方向键> |
| xlToRight | 向右移动，等同于在源单元格 <按 Ctrl + 右方向键>  |
| xlUp | 向上移动，等同于在源单元格 <按 Ctrl + 上方向键> |
| xlDown | 向下移动，等同于在源单元格 <按 Ctrl + 下方向键> |

图 4-46 使用 End 属性的参数 

什么时候会用到 End 属性 

可以用 Range 对象的 End 属性来解决这个问题，如图 4-47 所示。

图 4-47 在 A 列的第一个空单元格输入内容 

注意：如果 A 列全为空单元格，那 `Range("A65536").End (xlUp)` 返回的是 A1 单元格，同样的代码实际上是在 A2 单元格输入数据，如图 4-48 所示。

练习小课堂：

1、如果想让数值总是输入第一个空单元格，你有什么好办法？ 

图 4-48 当 A 列全为空时

2、除了使用 End 属性，还能用哪些方法得到 A 列的第一个非空单元格？能不能用 CurrentRegion 属性和 UsedRange 属性？试一试。

参考答案：

4.5.3 操作单元格，还需要了解什么 

单元格里的内容，Value 属性 

如果单元格是一个瓶子，Value 就是装在瓶子里的东西。输入内容，修改数据，这些都是在设置 Range 对象的 Value 属性。读取单元格的内容就是读取它的 Value 属性值。Value 是 Range 对象的默认属性，在给区域赋值时可以省略： 

但为了保证程序运行过程中不出现意外，建议养成保留 Value 属性而不省略它的习惯。

单元格个数，Count 一下就知道 Range 对象的 Count 属性返回指定的单元格区域中包含的单元格个数。如想知道 B4:F10 一共有多少个单元格，程序为： 

得到的结果如图 4-49 所示。

图 4-49 利用 Count 属性返回单元格个数 如想知道某个区域的行数或列数，代码为： 

单元格地址，Address 属性 想知道某个单元格的地址，可以读取它的 Address 属性，如图 4-50 所示。

图 4-50 使用 Address 属性 

4.5.4 亲密接触，操作单元格 

选中单元格，Activate 与 Select 方法 

选中活动工作表的 A1:B10 单元格，代码可以为： 

练习小课堂：尽管使用 Activate 和 Select 都可以选中指定的单元格，但两种方法并不完全相同。在 A1:B10 单元格区域呈选中状态时，分别用两种方法选中 B5 单元格，得到的结果一样吗？Select 和 Activate 方法的区别是什么？ 

参考答案：选中单元格区域后，再使用 Activate 方法激活该区域里的一个单元格，该区域依然呈选中状态，只改变活动单元格为激活的单元格。如果使用 Select 方法选中区域里的一个单元格，则只有用 Select 方法选中选择的单元格呈选中状态。

选择性清除单元格 

一个单元格里不仅数据，还有格式、批注等。不同的内容，可以使用【编辑】菜单里相应的菜单命令清除它们，如图 4-51 所示。

图 4-51 利用菜单命令选择性清除单元格内容 

练习小课堂：无论是清除内容还是格式，代码都可以通过录制宏得到。试一试，结合录制宏，写出表 4-8 中的代码。

表 4-8 

| 代码 | 代码说明 |
| --- | --- |
| 清除 B2:B15 单元格所有包括批 注、内容、注释、格式等内容 | - |
| 清除 B2:B15 单元格的批注 | - |
| 清除 B2:B15 单元格的内容 | - |
| 清除 B2:B15 单元格的格式 | - |

参考答案：

复制单元格区域 

开始之前，录制一个复制 A1 单元格到 C1 的宏，让我们在现成代码的基础上来学习复制单元格。但在执行复制或粘贴操作之前并不需要先选中单元格，所以录制的代码可以简化为： 

宏代码中省略了 Destination 参数名，完整的语句是： 

练习小课堂：复制单元格就像是做填空题，只要把源单元格和目标单元格填入相应的位置即可。事实上，在 VBA 中，不仅复制，所有的语句都是在做填空题。把 Sheet1 工作表的 A1:A10 复制到 Sheet2 工作表的 B1:B10，你能写出这个程序吗？ 

参考答案：如果要复制的单元格区域不能确定大小，可以只指定一个单元格作为目标区域的最左上角单元格，如图 4-52 所示。

图 4-52：只指定目标区域的最左上角单元格 

练习小课堂：如果只想粘贴源区域里的数值，代码应该怎么写？ 请录制一个选择性粘贴数值的宏，结合代码，编写一个程序，把 A1:D10 单元格的数值复制到 F1:10，不修改目标单元格的格式。

参考答案：

剪切单元格 

调用 Range 对象的 Cut 方法可以剪切单元格。

删除单元格 

调用 Range 对象的 Delete 方法可以删除单元格，同手动删除单元格一样，用 VBA 删除单元格后，也有 4 个删除选项，但用 VBA 删除时 Excel 并不会给出图 4-53 的【删除】对话框供你选择，需要在程序中用代码指定。

图 4-53 删除单元格时的 4 个选项 

练习小课堂：

1、结合录制宏，你能把表 4-9 中的代码写下来吗？ 

表 4-9     

| 代码 | 代码说明 |
| --- | --- |
| 删除 B5 单元格，删除后右侧单元格左移 | - |
| 删除 B5 单元格，删除后下方单元格上移 | - |
| 删除 B5 单元格所在的行 | - |
| 删除 B5 单元格所在的列 | - |

2、如果代码中不使用参数，如： Excel 会按表 4-9 中的哪种情况进行操作？ 

参考答案：

如果在删除时不使用参数，直接写为： 执行代码删除单元格后下方单元格上移，即相当于语句：

### 4.6 不止这些，其他常见的对象 

4.6.1 名称，Names 集合 

名称，就是名字 

Excel 中定义的名称就是给单元格区域（或数值常量、公式）取的名字。一个自定义的名称就是一个 Name 对象，Names 是工作簿中定义的所有名称的集合。关于 Names 的详细信息，可以在帮助里看到，如图 4-54 所示。

图 4-54 在帮助里查看名称的信息 

录制的宏告诉我们，怎样新建一个名称 

R5C [−2] ："R" 后面的数字代表行号，"C" 后面的数字代表列号。"R5C [−2]" 表示指定行与指定列相交的单元格。

C[−2] 中的 [] 是什么 

是否加中括号，决定单元格的引用方式是相对还是绝对引用。没有加中括号时使用绝对引用方式，反之则为相对引用。R5 表示工作表中的第 5 行，C [−2] 表示活动单元格左边的第 2 列。R5C [−2] 是对活动单元格左边第 2 列与工作表中第 5 行相交的单元格的引用，如图 4-55 所示。

图 4-55 R5C [−2] 引用的单元格 

如果要在行方向上使用相对引用，就在行号上加中括号，如果要在列方向上使用绝对引用，就去掉列号上的中括号。

可以使用 A1 样式的引用：

定义名称，更简单的方式：

怎样引用名称 

可以用名称名引用名称： 

也可以用名称的索引号引用名称： 

4.6.2 单元格批注，Comment 对象 口香糖瓶子的标签上写有「绿茶薄荷味」，指明口香糖的口味，这是标签的作用。单元格的批注就像贴在瓶子上的标签，对单元格作注释或说明。批注本身并不影响单元格内的数值，也不参与或影响计算。在 Excel 里，一个批注就是一个 Comment 对象，Comments 是工作簿中所有 Comment 对象的集合。

给单元格添加批注 

利用 VBA 新建的批注如图 4-56 所示。

图 4-56 利用 VBA 新建的批注 

注意： 如果单元格中已经有批注，再用程序为它添加批注时程序会出错，如图 4-57 所示。

图 4-57 在已经有批注的单元格中添加批注 

怎么知道单元格中是否有批注 

还可以这样操作批注 

4.6.3 给单元格化妆 

校长喜欢看什么样的成绩表 张老师将新计算好的成绩表（见图 4-58）拿给校长看，校长扫了一眼，微笑着拍拍他的肩膀说：「小张，以后的表格稍微设计一下，美观一点。」

图 4-58 张老师做的成绩表「校长觉得这个表不美观…… 那……」美观？怎样才叫美观？ 表格也需要化妆 没有丑女人，只有懒女人。女人需要打扮，表格也一样。我们可以像打扮自己一样，把表格打扮得漂漂亮亮。字体、单元格的底纹、边框等都是可以打扮的对象。设置字体，Font 对象 Font 对象（字体）决定表格里的内容以什么样的姿势表现出来。

给单元格添加底纹 

给表格设置边框 

其他设置 

可以在【单元格格式】对话框中进行其他设置，如图 4-59 所示，如果想用代码完成却不知道代码该怎么写，可以手动操作，用宏录制器录下它。

图 4-59【单元格格式】对话框 

练习小课堂：试着编写一个完整的程序，替张老师打扮一下成绩表。当张老师把你做好的成绩表拿到校长手里时，校长一定会很满意的。

### 4.7 典型的技巧与示例 

4.7.1 创建一个工作簿 

编写一个程序，按要求创建一个新工作簿，并把它保存到指定的文件夹。

Step1 ：插入一个模块（参阅 2.4.1 小节）。

Step2 ：在模块中输入下面的代码。

Step 3 ：运行程序后可以在本文件所在的文件夹中看到新建的文件，如图 4-60 所示。

图 4-60 用程序创建工作簿文件 

4.7.2 判断工作簿是否打开 

打开的工作簿很多，想知道名称为「成绩表」的工作簿是否打开，程序可以这样写： 

练习小课堂：4.7.2 小节中的程序先计算出当前打开的工作簿个数，再利用索引号引用工作簿，依次判断工作簿的名称是否是「成绩表.xls」。根据同样的思路，你能编写一个程序，判断当前活动工作簿中是否存在标签名称为「一年级」的工作表吗？试一试，编写一个这样的程序，如果没有这张工作表，就新建一张标签名称为「一年级」的工作表放在所有工作表之前，如果工作表已存在，将其移动到所有工作表之前。

参考答案：

4.7.3 判断工作簿是否存在 

文件夹中存了许多工作簿文件，想知道「员工花名册.xls」文件是否存在，可以用这个程序： 

4.7.4 向未打开的工作簿中录入数据 

4.7.5 隐藏活动工作表外的所有工作表 

4.7.6 批量新建工作表 

一张成绩表的 C 列保存着许多不同的班级名称，如图 4-61 所示。

图 4-61 成绩表 

根据 C 列的班级名新建不同的班级工作表，工作表以班级名命名，可以用这个程序： 运行程序后 VBA 会自动完成新建工作表的任务，如图 4-62 所示。

图 4-62 程序运行前后 

练习小课堂：但是，C 列的单元格有可能是重复的，如图 4-63 所示。

图 4-63 实际的工作表 

试一试，编写这个批量新建工作表的程序，你能做到吗？ 

参考答案：

4.7.7 批量对数据分类 

不同的班级工作表建好了，接下来将根据班级名对成绩表进行分类，将各个班级的记录分类到相应的工作表里。运行程序后的效果如图 4-64 所示。

图 4-64 运行程序前后 

练习小课堂：如果班级工作表中原来已经有记录，执行程序，在班级工作表中添加记录前，要将原有记录清除，你知道怎么修改程序吗？ 

参考答案：执行 4.7.7 小节中对数据分类的程序前，先执行下面的程序，清除各班级表中的数据记录。

4.7.8 将工作表保存为新工作簿 

工作簿里有许多班级成绩表，如果想把各个班级的成绩表保存为一个单独的工作簿文件，可以用这个程序，如图 4-65 所示。

图 4-65 将工作表保存为工作簿 

4.7.9 快速合并多表数据 

工作簿中保存着各个班级的成绩表，如果想把所有班级的成绩表汇总到一张工作表中，汇总多表数据，可以用这个程序： 

4.7.10 汇总同文件夹下多工作簿数据 

某文件夹下有许多工作簿，如图 4-66 所示，每张工作簿里只有一张工作表且结构相同，如图 4-67 所示，分别保存各班级的学生名册。

图 4-66 同一文件夹下的多个工作簿 

图 4-67 工作表的结构 

把各个工作簿中保存的信息汇总到同文件夹中另一个工作簿的同一张工作表里，这是领导交给小张的工作。完成这个任务，可以用这个程序。执行程序后不用手动去复制粘贴，所有的记录全都汇总到程序所在工作簿的活动工作表中，如图 4-68 所示。

图 4-68 汇总后的工作表

 4.7.11 为工作表建立目录 工作簿中有许多工作表，想为工作表建一个目录，可以用这个程序，如图 4-69 所示。
 
 图 4-69 建立工作表目录

## 0501. Excel 事件 

楼梯间的电灯开关：楼梯间装有电灯，但小丽记性不好，上楼后老是忘记关灯，而且每天晚上在漆黑的墙壁上寻找开关也让她感到头痛。同事说，可以装一个声光控开关。声光控开关，装上后真的很方便，小丽对这个自动化的电灯开关很满意。

VBA 中也有开关：按钮、图片、快捷键等都是 VBA 程序的开关。这类开关只有按下，程序才会运行。声光控开关认识小丽走到楼梯口的动作，当「听」到这个动作发出的声音后就会自动打开电灯。我们每天都在 Excel 里执行不同的操作，其中的某些特殊操作是 Excel 认识的，所以可以像安装声光控开关一样，给 VBA 程序安装一个自动运行的开关，当我们做了某个 Excel 认识的操作后自动运行指定的程序。

### 5.1 让 Excel 自动响应你的行为

5.1.1 让 Excel 自动问好 

给程序加代码，让 Excel 自动问好，如图 5-1 所示。

图 5-1 输入程序 

完成后关闭并保存工作簿。重新打开它，就可以看到效果了，如图 5-2 所示。

图 5-2 打开文件后自动问好 

在本例中，不用手动单击按钮运行程序，这是因为我们给程序安装了一个自动开关。

5.1.2 事件，VBA 里的自动开关 

什么是事件 

声控开关认识小丽在楼梯口踢高跟皮鞋的动作，所以当开关「听」到这个动作发出的声音后就自动打开电灯。这里踢高跟皮鞋的动作就是事件。在 Excel 里，事件就是一个能被对象识别的操作。事件是怎么控制程序的「当有人踢皮鞋的时候自动开灯。」这是声控开关记住的规则。在 Excel 中，事件也按类似的规则控制程序。「当打开工作簿的时候自动运行程序。」这是 `Workbook_Open` 事件控制程序的规则，于是，每次打开工作簿时，都会自动运行这个程序。「当…… 的时候自动运行程序」，总是可以用这样的语句去描述一个 Excel VBA 的事件过程。

练习小课堂：试一试，把 5.1.1 小节中编写的程序写在模块对象里，再次打开工作簿，Excel 向你问好了吗？猜一猜，为什么会出现这种情况？ 

参考答案：不能运行，原因参阅 5.1.3 小节。

5.1.3 事件过程 

因为 Workbook（工作簿）对象能识别 Open（打开）这个动作，所以打开工作簿就会自动运行相应的程序。像这种当某个事件发生后自动运行的过程称为事件过程。事件过程也是 Sub 过程。事件过程必须写在特定对象所在的模块中，而且只有过程所在的模块里的对象才能触发这个事件。

5.1.4 编写事件过程 

事件过程的过程名由 Excel 自动设置，以「对象名称_事件名称」的形式存在，不能更改。进入 VBE，想编写关于哪个对象的事件过程，就在【工程资源管理器】中双击激活该对象所在模块的【代码窗口】。如果想写这样的一个程序，当激活 Sheet1 工作表时，自动完成某些操作或计算，步骤如图 5-3 所示。

图 5-3 编写事件的过程 完成后重新激活代码所在的工作表，程序就运行了。

### 5.2 Worksheet 事件

5.2.1 关于 Worksheet 事件 

Worksheet 事件是发生在 Worksheet 对象里的事件，如图 5-4 所示。

图 5-4 Worksheet 对象 

Worksheet 事件过程必须写在相应的 Worksheet 对象里，只有过程所在的 Worksheet 对象里的操作才能触发该事件。

5.2.2 常用的 Worksheet 事件 

`Worksheet_Change` 事件：自动提示更改的内容 `Worksheet_Change` 告诉 Excel，当过程所在工作表的单元格发生更改时自动运行程序过程，程序必须写在相应的工作表对象里，如图 5-5 所示。

图 5-5 在工作表里添加事件过程 

在 Sub 与 End Sub 的中间添加执行的语句： 完成后返回该工作表区域，更改任意单元格的内容，按回车确认后可以看到程序运行的效果，如图 5-6 所示。

图 5-6 更改单元格内容后自动运行程序 

练习小课堂：1）如果只有更改 A 列单元格时才自动运行程序，程序应该怎样写？ 2）无论是手动还是使用 VBA 代码更改单元格，都会触发 Worksheet 的 Change 事件。

当单元格被修改后，自动在单元格内容的前面加上「新内容：」，如图 5-7 所示，在工作表模块中输入下面的程序，可以实现预期的目的吗？如果不能，程序应该怎样写？ 

图 5-7 希望程序运行的效果 

参考答案：

因为用程序更改单元格后会再次触发 Worksheet_Change 事件，再次运行程序，所以原程序不能得到预期的目的。可以将程序更改为： 

`Worksheet_SelectionChange` 事件：你选中了谁 

`Worksheet_SelectionChange` 事件告诉 Excel，当工作表中选定的单元格发生改变时自动运行程序，运行后的效果如图 5-8 所示。

图 5-8 程序运行后的效果 

练习小课堂：1）编写程序，当选中 A1 单元格时，提示 A1 单元格的内容。2）编写程序，当选中的单元格不是 A 列的单元格时，自动选中同行 A 列的单元格。

参考答案：

`Worksheet_Activate` 事件：自动提示工作表名 

`Worksheet_Activate` 事件告诉 Excel，当激活工作表时自动运行程序。在 Sheet1 工作表模块里写入程序，重新激活工作表，程序就自动运行了，如图 5-9 所示。

图 5-9 激活工作表时自动运行程序 

`Worksheet_Deactivate` 事件：禁止选中其他工作表 `Worksheet_Deactivate` 事件告诉 Excel，当工作表由活动工作表变为不活动工作表时自动运行过程。在 Sheet1 工作表模块中写入下面的程序： 

输入程序后，当激活其他工作表时，Excel 会进行提示，并自动重新激活 Sheet1 工作表，如图 5-10 所示。

图 5-10 禁止激活其他工作表

5.2.3 Worksheet 事件列表 

Worksheet 对象一共有 9 个事件可供使用，如表 5-1 所示。

表 5-1 Worksheet 对象的事件列表     

| 事件名称 | 事件说明 |
| --- | --- |
| Activate | 激活工作表时发生 |
| BeforeDoubleClick |  双击工作表之后，默认的双击操作之前发生 |
| BeforeRightClick | 右击工作表之后，默认的右击操作之前发生 |
| Calculate | 重新计算工作表之后发生 |
| Change | 工作表中的单元格发生更改时发生 |
| Deactivate | 工作表由活动工作表变为不活动工作表时发生 |
| FollowHyperlink | 单击工作表中的任意超链接时发生 |
| PivotTableUpdate | 在工作表中更新数据透视表之后发生 |
| SelectionChange | 工作表中所选内容发生更改时发生 |

### 5.3 Workbook 事件

5.3.1 关于 Workbook 事件 

Workbook 事件是发生在 Workbook 对象里的事件。进入 VBE，在【工程资源管理器】中可以看到 ThisWorkbook 模块，如图 5-11 所示。

图 5-11 ThisWorkbook 模块 

5.3.2 常用的 Workbook 事件 

Open 事件 

`Workbook_Open` 事件告诉 Excel，当打开工作簿时自动运行程序。

练习小课堂：「当打开工作簿后，总是让第一张工作表成为活动工作表」，这样的程序你知道应该怎样写吗？（可参阅 5.1.1 小节） 

参考答案：在 ThisWorkbook 对象中写入程序： 

保存关闭工作簿，再重新打开它即可。

BeforeClose 事件 

`Workbook_BeforeClose` 事件告诉 Excel，在关闭工作簿之前自动运行程序。

在 ThisWorkbook 模块中输入该程序后，每次关闭工作簿都会自动运行程序，让你选择是否关闭工作簿，如图 5-12 所示。

图 5-12 关闭工作簿前的提示框表 

`Workbook_SheetChange` 事件 

`Workbook_SheetChange` 事件告诉 Excel，当工作簿里任意一个单元格被更改时，自动运行程序。

练习小课堂：你知道 `Workbook_SheetChange` 事件与 `Worksheet_Change` 事件的异同吗？ 你认为什么时候应该使用 `Workbook_SheetChange` 事件？什么时候应该使用 `Worksheet_Change` 事件？ 

参考答案：如果只想在指定的某张工作表中更改选中的单元格时自动运行程序，使用 `Worksheet_Change` 事件比较适合；如果希望选中工作簿中任意一张工作表里的单元格都自动运行程序，使用 `Workbook_SheetChange` 事件更适合。

5.3.3 Workbook 事件列表 

Workbook 事件名称及相应说明见表所示。

表 5-2 Workbook 事件列表     

| 事件名称 | 事件说明 |
| --- | --- |
| Activate | 当激活工作簿时发生 |
| AddinInstall | 当工作簿作为加载宏安装时发生 |
| AddinUninstall | 当工作簿作为加载宏卸载时发生 |
| AfterXmlExport | 在保存或导出指定工作簿中的 XML 数据之后发生 |
| AfterXmlImport | 在刷新现有 XML 数据连接或新的 XML 数据被导入任意一个打开的工作簿后发生 |
| BeforeClose | 在关闭工作簿前发生。如果工作簿已更改，则此事件在询问用户是否保存更改之前发生 |
| BeforePrint | 在打印指定工作簿（或其中任何内容）之前发生 |
| BeforeSave | 在保存工作簿前发生 |
| BeforeXmlExport | 在保存或导出指定工作簿中的 XML 数据之前发生 |
| BeforeXmlImport | 在刷新现有 XML 数据连接或新的 XML 数据被导入任意一个打开的工作簿前发生 |
| Deactivate | 在工作簿从活动状态转为非活动状态时发生 |
| NewSheet | 在工作簿中新建工作表时发生 |
| Open | 在打开工作簿时发生 |
| PivotTableCloseConnection | 在数据透视表的连接关闭之后发生 |
| PivotTableOpenConnection | 在数据透视表的连接打开之后发生 |
| SheetActivate | 在激活任意工作表时发生 |
| SheetBeforeDoubleClick | 在双击任意工作表时（默认的双击操作之前）发生 |
| SheetBeforeRightClick | 在右键单击任意工作表时（默认的右键单击操作之前）发生  |
| SheetCalculate | 在重新计算工作表时或在图表上绘制更改的数据之后发生 |
| SheetChange | 当更改了任何工作表中的单元格时发生 |
| SheetDeactivate | 当工作表从活动工作表变为不活动工作表时发生 |
| SheetFollowHyperlink | 当单击工作簿中的任何超链接时发生 |
| SheetPivotTableUpdate | 在更新数据透视表的工作表后发生 |
| SheetSelectionChange | 当任意工作表上的选定区域发生更改时发生（但图表工作表上的选定区域发生改变时，不会发生此事件） |
| Sync | 当作为「文档工作区」一部分的工作簿的本地副本与服务器上的副本进行同步时发生 |
| WindowActivate | 在激活任意工作簿窗口时发生 |
| WindowDeactivate | 当任意工作簿窗口由活动窗口变为不活动窗口时发生 |
| WindowResize | 在调整任意工作簿窗口的大小时发生 |

### 5.4 别样的自动化 

5.4.1 MouseMove 事件 

当鼠标指针移动到按钮上时，按钮迅速闪开。鼠标和按钮，就像在玩老鹰捉小鸡的游戏。这样的效果可以用命令按钮的 MouseMove 事件实现，如图 5-13 所示。

图 5-13 在工作表中添加一个按钮 新添加的按钮，可以通过在【属性窗口】中设置它的属性来改变它的外观样式，如图 5-14 所示。

图 5-14 利用属性窗口设置按钮的属性 

完成后在按钮所在工作表的【代码窗口】中输入程序，如图 5-15 所示。

图 5-15 在代码窗口中写入程序 

完成后返回工作表区域，在【控件工具箱】中单击【退出设计模式】按钮，如图 5-16 所示。

图 5-16 退出设计模式完成编辑 

完成后就可以用鼠标指针去「抓」按钮了，试一试，你能把鼠标指针放到按钮上面吗？如果按钮跑远了，想让按钮回到初始位置，就单击 Back 按钮。在工作表中再添加一个按钮，命名为 "Back"，双击按钮，在代码窗口中输入程序： 

5.4.2 不是事件的事件 

除了对象的事件，Application 对象还有两种方法，可以像事件一样让程序自动运行。Application 对象的 OnKey 方法 OnKey 方法告诉 Excel，当在键盘上按下指定键或组合键时自动运行程序。

Step 1： 进入 VBE，新插入一个模块，在模块中输入程序： 

Step 2： 把需要自动运行的代码全部写在单独的过程 Test 里，保存在模块中： 步骤如图 5-17 所示。

图 5-17 输入程序的步骤 

Step 3： 运行 ok 过程，返回工作表区域，按 `<Shift+E>` 组合键即可自动运行 Test 过程，如图 5-18 所示。

图 5-18 当按下 `<Shift+e>` 后如果想知道还能设置哪些快捷键，可以查看 OnKey 方法的帮助信息，如图 5-19 所示。

图 5-19 查看 OnKey 的帮助信息

Application 对象的 OnTime 方法 

OnTime 方法告诉 Excel，当到指定的时间时自动运行程序（可以是指定的某个时间，也可以是指定的一段时间之后），如图 5-20 所示。

Step 1：进入 VBE，新插入一个模块，在模块中写入程序。

Step 2：把提醒休息时间的语句写在另一个程序 Test 里，保存在模块中。

图 5-20 输入程序的步骤 

Step 3：运行 oT 过程，开始工作，一个小时后 Excel 会自动运行 Test 过程，如图 5-21 所示。

图 5-21 Excel 的温馨提示 

练习小课堂：发现了吗？ 无论是 OnKey 还是 OnTime 方法，想让指定的程序自动运行，都必须先运行该方法所在的程序，如果不运行 ok 或 oT 过程，指定的 Test 过程并不会自动运行。如果想省去手动运行 ok 或 oT 过程的步骤，想一想，你有什么好的办法？

参考答案：在 ThisWorkbook 对象中输入下面的过程即可。

### 5.5 典型的技巧与示例 

5.5.1 一举多得，快速录入数据 

商店里每售出一件商品，都要把相应的信息输入到「商品销售登记表」中，如图 5-22 所示。

图 5-22 商品销售登记表 

Step 1：建一张参照表，指明各种商品的商品名称、商品代码、单价等信息，如图 5-23 所示。

图 5-23 登记表里的参照表 

Step 2： 在该工作表模块里写入程序。

Step 3： 返回工作表区域，在商品名称列输入商品名称的首字母，查看程序运行效果，如图 5-24 所示。

图 5-24 输入内容前后 

5.5.2 我该监考哪一场 一张监考安排表，密密麻麻的全是监考老师的名字，如图 5-25 所示。

图 5-25 监考安排表

Step 1： 在「监考安排表」所在的工作表模块中输入程序。

Step 2： 返回工作表区域，想知道张姣老师监考哪些考场，就用鼠标选中她的姓名所在的任意一个单元格，如图 5-26 所示。

图 5-26 高亮显示指定同一姓名的老师所在的单元格 

练习小课堂：如果想高亮显示工作表中选中单元格所在的行和列，应该怎么编写程序？

参考答案：如果数据区域是 B3:Q22，可以在数据所在的工作表对象中输入下面的程序。
 
5.5.3：让文件每隔一分钟自动保存一次「晕死，怎么又停电了，我做了一上午的表格还没保存。」这一幕，经常发生在我同事的身上。看着他欲哭无泪的样子，我只能深表同情。其实，这样的遗憾是可以避免的。如果你担心自己会有同样悲催的经历，可以编写一个程序，让你的文件每隔一段时间自动保存一次。

Step 1：新插入一个模块，在模块中输入程序，如图 5-27 所示。

图 5-27 在模块中输入程序 

Step 2： 在 ThisWorkbook 模块中输入程序，如图 5-28 所示。

图 5-28 在 ThisWorkbook 模块中输入程序 

Step 3：保存修改，关闭并重新打开工作簿，你就可以放心使用，而不用担心文件没有保存了。

练习小课堂：想一想，为什么要在 ThisWorkbook 模块中写入 5.5.3 小节 Step 2 中的程序？

参考答案：目的是让打开工作簿时，自动运行 otime 过程，实现自动保存的目的。

## 0601. 用户界面设计

### 6.1 在 Excel 中自由地设计界面

6.1.1 关于用户界面 

为什么要设计用户界面 

用户界面就像电视机的遥控板，是用户与程序进行互动的窗口。一个合理的程序，总会设计一个或多个供用户操作的界面。用户界面不仅能为操作提供便利，还能增强视觉感，使程序显得更直观、更专业。怎样设计用户界面 同绘画一样，设计界面就是用户按自己的意愿，在工作表或用户窗体中有目的地添加控件，并给这些控件指定功能。

6.1.2 控件，必不可少的调色盘 

Excel 里有两种类型的控件：窗体控件（【窗体】工具栏中的控件）和 ActiveX 控件（【控件工具箱】中的控件）。

窗体控件 

要向工作表中添加窗体控件，应先调出【窗体】工具栏，如图 6-1 所示。

图 6-1 调出【窗体】工具栏 

【窗体】工具栏中一共有 16 个控件，其中有 9 个可以添加到工作表中，如图 6-2 所示，控件说明见表 6-1 所示。

图 6-2 窗体工具栏中可使用的控件 

表 6-1 各种窗体控件的说明     

| 控件名称 | 控件说明 |
| --- | --- |
| 标签 | 用于输入和显示静态文本 |
| 分组框 | 用于组合其他多个控件 |
| 按钮 | 用于执行宏命令 |
| 复选框 | 选择控件，可以多项选择 |
| 选项按钮 | 用于选择的控件，通常几个选项按钮用组合框组合在一起使用，在一组中只能同时选择一个选项按钮 |
| 列表框  | 显示多个选项的列表，用户可以从中选择一个选项  |
| 组合框 | 提供可选择的多个选项，用户可以选择其中的一个项目 |
| 滚动条 | 包括水平滚动条和垂直滚动条 |
| 微调控件 | 通过单击控件的箭头来选择数值 | 

ActiveX 控件 

要添加 ActiveX 控件，应先调出【控件工具箱】，如图 6-3 所示。

图 6-3 调出控件工具栏 

默认情况下，【控件工具箱】中有 11 个控件，如图 6-4 所示。

图 6-4 控件工具箱中默认的控件 

但能使用的 ActiveX 控件并不只有 11 个，单击【控件工具箱】中的【其他控件】按钮，如图 6-5 所示。

图 6-5 选择其他的控件

### 6.2 使用控件，将工作表当作画布

窗体控件和 ActiveX 控件就像两个调色盘，画蓝天的时候从里面选择蓝色，画白云的时候从里面选择白色。而 Excel 的工作表就像一张大画布，你可以在上面任意勾勒，绘出一幅漂亮的蓝天白云图。

6.2.1 在工作表中使用窗体控件 

添加一个组合框控件 

调出【窗体】工具栏，选中组合框控件，按住鼠标左键的同时，拖动鼠标即可在工作表中添加控件，如图 6-6 所示。

图 6-6 添加控件 

设置控件格式 

设置控件格式的步骤如图 6-7 所示。

图 6-7 设置控件 

如果想修改控件的名称，可以选中控件，在名称框里修改，如图 6-8 所示。

图 6-8 修改控件的名称 

使用控件 

使用窗体控件的步骤如图 6-9 所示。

图 6-9 使用窗体控件 

6.2.2 在工作表中使用 ActiveX 控件 

向工作表中添加选项按钮 在【控件工具箱】中选择【选项按钮】控件，按住鼠标左键的同时，拖动鼠标即可在工作表中添加一个选项按钮，如图 6-10 所示。

图 6-10 在工作表中添加选项按钮 

设置控件格式 新添加的按钮，可以在【属性窗口】中设置它的属性来更改它的外观样式，如图 6-11 所示。

图 6-11 设置 ActiveX 控件的格式 

继续在工作表中添加一个选项按钮控件，在【属性窗口】中设置标签为「女」，名称为 xb2，如图 6-12 所示。

图 6-12 新添加的 ActiveX 控件 

为控件添加程序 ActiveX 控件与窗体控件不同，在使用前，需要用户针对控件编写相应的代码。前文添加的两个控件，如果想知道用户选择的是「男」还是「女」，得分别给这两个控件编写事件过程，如图 6-13 所示。

图 6-13 为控件添加事件过程 

用同样的方法为控件 xb2 编写事件过程，如图 6-14 所示。

图 6-14 为控件添加的程序代码 

使用控件 

返回工作表区域，单击【控件工具箱】中的【退出设计模式】按钮，就可以使用控件了，如图 6-15 所示。

图 6-15 在工作表中使用 ActiveX 控件 

6.2.3 窗体控件和 ActiveX 控件的区别 

窗体控件只能在工作表中通过设置控件的格式或指定宏来使用，ActiveX 控件拥有很多属性和事件，可以在工作表和用户窗体中使用。如果是以编辑数据为目的，一般使用窗体控件就可以了，但如果在编辑数据的同时还要进行其他操作，使用 ActiveX 控件会灵活得多。

### 6.3 与用户交互，简单的输入输出对话框 

对话框是程序与用户进行交互的工具，用来输入或输出信息。

6.3.1 InputBox 函数 

InputBox 函数创建一个接受用户输入的对话框，供用户输入数据。运行程序后 Excel 会显示一个对话框，如图 6-16 所示。

图 6-16 运行程序后显示的对话框 

根据提示，在对话框中输入姓名后单击【确定】按钮，输入的姓名即可自动写进活动工作表的 A1 单元格，如图 6-17 所示。

图 6-17 利用对话框输入姓名 

编写代码时，所有的参数名称都是可以省略的。除了 prompt 参数外，其实参数都可以省略。也可以只省略其中的一个或几个参数。

6.3.2 Application 对象的 InputBox 方法 

使用 Application 对象的 InputBox 方法也可以创建接受用户输入的对话框。除了 Left 与 Top 参数，InputBox 方法的其他参数与 InputBox 函数的参数的作用相同。InputBox 方法的 Left 和 Top 参数指定对话框在 Excel 工作表窗口中的位置，如图 6-18 所示，而 InputBox 函数的 xpos 与 ypos 参数指定对话框在整个屏幕窗口中的位置，如图 6-15 所示。

图 6-18 InputBox 方法的 Top 与 Left 参数 

既生 InputBox 函数，何生 InputBox 方法 

对比一下它们的参数区别，可以知道二者的区别。完整的参数，可以在 VBA 帮助里看到，也可以在输入代码的时候，在代码窗口里看到，如图 6-19 所示。

图 6-19 在代码窗口中查看参数 InputBox 函数只能返回一个 String 型的字符串，而 InputBox 方法返回的数据类型不确定，并且，InputBox 方法比 InputBox 函数多一个 Type 参数。

Type 参数有什么作用 

设置 InputBox 方法的 Type 参数值，指定返回的数据类型，如表 6-2 所示。

表 6-2 Type 参数说明    

| 参数值 | 含义 |
| --- | --- |
| 0 | 公式 |
| 1 | 数字 |
| 2 |  文本（字符串）  |
| 4 | 逻辑值（True 或 False） |
| 8 | 单元格引用（Range 对象） |
| 16 | 错误值，如 #N/A |
| 64 | 数值数组 |

下面的程序让用户选择一个单元格区域，然后在单元格区域输入数值 100，如图 6-20 所示。

图 6-20 使用 InputBox 方法 

如果返回值为多种类型中的一种，就把 Type 参数的值设为相应类型的和。

练习小课堂：在表 6-2 中，你知道 Type 的参数值为什么是 0、1、2、4、8…… 这样有间隔而不是连续的自然数吗？ 

参考答案：因为中间空开的数值（如 3）可以是多种参数值之和（如 1+2），为了不混淆，所以参数值是有间隔而不是连续的自然数。

6.3.3 MsgBox 函数 

使用 MsgBox 函数，可以创建一个对话框，告诉用户某些信息，并等待用户单击其中某个按钮后继续运行。其效果如图 6-21 所示。

图 6-21 MsgBox 函数创建的对话框 

设置显示的按钮 MsgBox 函数一共有 6 种按钮设定，如表 6-3 和图 6-22 所示。

表 6-3 Msgbox 的 6 种按钮设定     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbOkonly | 0 | 只显示【确定】按钮 |
| vbOkCancel | 1 | 显示【确定】和【取消】两个按钮 |
| vbAbortRetryIgnore | 2 | 显示【终止】、【重试】和【忽略】3 个按钮 |
| vbYesNoCancel | 3 | 显示【是】、【否】和【取消】3 个按钮 |
| vbYesNo | 4 | 显示【是】和【否】两个按钮 |
| vbRetryCancel | 5 | 显示【重试】和【取消】两个按钮 |

图 6-22 Msgbox 函数 6 种按钮设定 

设置显示的图标样式 MsgBox 函数一共有 4 种图标样式，如表 6-4 和图 6-23 所示。

表 6-4 Msgbox 的 4 种图标样式     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbCritical | 16 | 显示「关键信息」图标 |
| vbQuestion | 32 | 显示「警告询问」图标 |
| vbExclamation | 48 | 显示「警告消息」图标 |
| vbInformation | 64 | 显示「通知消息」图标 |

图 6-23 不同的图标样式 

可以同时设置显示的按钮和图标，在两个常数或值之间用 + 号连接：

其效果如图 6-24 所示。

图 6-24 设置按钮及显示图标 

设置缺省按钮 

默认情况下按回车键即可执行的按钮称为缺省按钮，如图 6-25 所示。

图 6-25 缺省按钮 

如果要修改第二个按钮为缺省按钮，可以设置 Buttons 参数的参数值。其效果如图 6-26 所示。

图 6-26 设置第 2 个按钮为缺省按钮 如果想设置第三个、第四个按钮为缺省按钮，相应的参数如表 6-5 所示。

表 6-5 设置缺省按钮的参数     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbDefaultButton1 | 0 | 第一个按钮为缺省按钮 |
| vbDefaultButton2 | 256 | 第二个按钮为缺省按钮 |
| vbDefaultButton3 | 512 | 第三个按钮为缺省按钮 |
| vbDefaultButton4 | 768 | 第四个按钮为缺省按钮 |

指定对话框类型 

Buttons 参数还有第四组设定值，用来决定对框的类型，如表 6-6 所示。

表 6-6 对话框的类型     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbApplicationModal | 0 | 应用程序强制返回；暂停执行应用程序，直到用户对消息框作出响应才继续工作 |
| vbSystemModal | 4096 | 系统强制返回；暂停执行所有程序，直到用户对消息框作出 响应才工作 |

MsgBox 函数的返回值 

设置 Buttons 参数可以让对话框显示不同的按钮，单击不同的按钮，将返回不同的值，如表 6-7 所示，程序可以根据返回值选择不同的操作，如：

表 6-7 MsgBox 函数的返回值

| 常数 | 值 | 描述 |
| --- | --- | --- |
| vbOK | 1 | 单击【确定】按钮 |
| vbCancel | 2 | 单击【取消】按钮 |
| vbAbort | 3 | 单击【终止】按钮 |
| vbRetry | 4 | 单击【重试】按钮 |
| vbIgnore | 5 | 单击【忽略】按钮 |
| vbYes | 6 | 单击【是】按钮  |
| vbNo | 7 | 单击【否】按钮 |

6.3.4 Application 对象的 FindFile 方法 

使用 Application 对象的 FindFile 方法可以显示【打开】对话框，用户可以在对话框中选择并打开文件，如图 6-27 所示。

1-2『这里的 FindFile 以后很多地方会用到，收录进主题卡「VBA 对象方法」里去。（2021-03-20）』—— 已完成

图 6-27 用 FindFile 方法打开文件 

6.3.5 Application 对象的 GetOpenFilename 方法 

1-2『 GetOpenFilename 方法收录进主题卡「VBA 对象方法」里去。（2021-03-20）』—— 已完成

可以调用 Application 对象的 GetOpenFilename 方法显示【打开】对话框，在对话框里选择文件，获得文件名称。虽然同是显示【打开】对话框，但 GetOpenFilename 方法并不会打开选中的文件，而是返回所选文件的文件名（含路径）字符串，如图 6-28 所示。

图 6-28 不使用参数时 

可以使用 FileFilter 参数限制可选择的文件类型，如图 6-29 所示。

图 6-29 使用参数限制文件类型 

如果希望能在两种或多种类型的文件中选择，可以修改参数值，如图 6-30 所示。

图 6-30 使用参数限制文件类型 

也可以增加文件类型下拉列表中的项目，如图 6-31 所示。

图 6-31 增加文件类型下拉列表中的项目 

除了 filefilter，GetOpemFilename 方法还有其他参数，如图 6-32 所示。

图 6-32 当设置更多参数时 

6.3.6 Application 对象的 GetSaveAsFilename 方法 

可以调用 Application 对象的 GetSaveAsFilename 方法打开【另存为】对话框，在对话框里选择文件，获得文件名，如图 6-33 所示。

图 6-33 用 GetSaveAsFilename 方法获取文件名 

6.3.7 Application 对象的 FileDialog 属性 

使用 Application 对象的 FileDialog 属性可以获得指定目录的路径及名称，如图 6-34 所示。

图 6-34 获取目录名称 

除了 msoFileDialogFolderPicker，filedialogtype 参数还可以选用其他的值，如表 6-8 所示。

表 6-8 msoFileDialogType 

| 常量列表 | 常量说明 |
| --- | --- |
| msoFileDialogFilePicker | 允许选择一个文件 |
| msoFileDialogFolderPicker | 允许选择一个文件夹 |
| msoFileDialogOpen | 允许打开一个文件 |
| msoFileDialogSaveAs | 允许保存一个文件 |

### 6.4 构建用户窗体，自己设计交互界面 

6.4.1 关于用户窗体 

用户窗体是 Excel 中的另一对象 —— UserForm 对象。用户可以在窗体上自由添加 ActiveX 控件，并利用这些控件从用户那里获得信息，或将信息输出给用户。

1-2『 UserForm 对象，这不就是 autolisp 里的 dcl 组件么，跟三方包 opendcl 的功能也一样。做一张术语卡片。（2021-03-20）』—— 已完成

6.4.2 添加一个用户窗体 

添加一个用户窗体的方法如图 6-35 和图 6-36 所示。

方法一：图 6-35 利用菜单命令插入窗体 

方法二：图 6-36 利用右键菜单插入窗体 

6.4.3 设置窗体的属性 

作为对象，用户窗体也有自己的属性，如名称、大小等。新窗体的所有属性都是默认的，可以在【属性窗口】中重新设置，如图 6-37 所示。

图 6-37 设置窗体 想将窗体设置为何种样式，就在【属性窗口】里修改对应的属性。为了便于查询，Excel 允许用户按不同的排序方式查看对象的属性，如图 6-38 所示。

图 6-38 按分类序查看对象属性 

如果对属性列表中某个属性不太熟悉，选中属性名称，按 `<F1>` 键，即可查看关于它的帮助信息，如图 6-39 所示。

图 6-39 查看帮助信息 

6.4.4 在窗体上添加控件 

新插入的窗体，只是一个空白的对话框，要想实现同用户交互的目的，需要往窗体上添加不同的控件。要向窗体中添加控件，应先调出【工具箱】，如图 6-40 所示。

图 6-40 调出工具箱 

向窗体中添加控件的方法如图 6-41 和图 6-42 所示。

图 6-41 向窗体中添加控件 

图 6-42 设置控件的属性 

练习小课堂：参照添加和设置标签控件的方法，继续在窗体上添加其他控件，设计一个简单的信息录入界面，如图 6-43 所示。

图 6-43 信息录入界面 

6.4.5 显示窗体 

显示窗体就是把设计好的窗体显示给用户。手动显示窗体 手动显示窗体的方法如图 6-44 所示。

图 6-44 手动显示窗体 用代码显示窗体 

显示一个窗体要经过两个步骤：如果在调用窗体的 Show 方法前窗体没有加载，Excel 会自动加载这个窗体，然后再显示它。所以显示窗体可以省略加载窗体的语句，直接调用窗体对象的 Show 方法。

窗体的显示模式 

模式窗体：窗体显示后将停止执行「显示窗体」之后的代码，直到退出或隐藏窗体，并且只有退出或隐藏窗体后，才可以操作窗体外的其他元素，如图 6-45 所示。

图 6-45 显示模式窗体 

无模式窗体：窗体显示后会继续执行程序里余下的语句，并且可以操作其他窗体或界面，如图 6-46 所示。

图 6-46 显示无模式窗口 

6.4.6 关闭窗体 

手动关闭窗体 

手动关闭窗体如图 6-47 所示。

图 6-47 手动关闭窗体 

使用代码关闭窗体 

如果想取消显示窗体，可以隐藏或卸载它。尽管隐藏和卸载窗体都能将窗体从屏幕上删除，但因为显示一个隐藏的窗体比显示一个卸载的窗体用的时间短，所以当需要反复使用某个窗体时，建议用 Hide 方法隐藏，而不用 Unload 语句卸载它。

6.4.7 使用控件 

作为对象，窗体和窗体上的控件，都有不同的事件。想让窗体真正工作起来，应为窗体和控件编写相应的事件过程。初始化窗体，UserForm 对象的 Initialize 事件 加载窗体时会触发 Initialize 事件。在这个事件中，可以对窗体、变量等进行初始化设置，如图 6-48 所示。

图 6-48 使用 Initialize 事件 设置性别复合框的条目为「男」和「女」后如图 6-49 所示。

图 6-49 使用控件 

为命令按钮添加事件过程 

Step 1 ：用同样的方法给「确定」按钮添加事件过程。

Step 2 ：给【退出】按钮添加事件过程。使用窗体录入数据 完成上述设置后，显示窗体，就可以使用窗体向工作表中录入数据了，如图 6-50 所示。

图 6-50 使用窗体录入数据 

6.4.8 用键盘控制控件 

更改控件的 `<Tab>` 键顺序 只有对象具有焦点时，才能接受键盘输入。控件的 `<Tab>` 键顺序决定用户在按下 `<Tab>` 键或 `<Shift+Tab>` 组合键后激活控件的顺序。在设计用户窗体时，系统会按添加控件的先后顺序确定控件的 `<Tab>` 键顺序。当然，这个顺序是可以更改的，如图 6-51 所示。

图 6-51 更改控件的 `<Tab> `键顺序 给控件指定快捷键 

给控件指定快捷键如图 6-52 所示。

图 6-52 给控件设置快捷键 

设置【确定】按钮的 Accelerator 属性为 N 后，按下 `<Alt+N>` 组合键，就等同于在窗体中单击【确定】按钮。

### 6.5 改造 Excel 现有的界面

6.5.1 更改标题栏的程序名称 

Excel 的标题栏用于显示程序及文件名称，默认的程序名称为 "Microsoft Excel"，可以设置 Application 对象的 Caption 属性修改它，如图 6-53 所示。

图 6-53 更改标题栏程序名称 

6.5.2 显示或隐藏菜单栏 

隐藏菜单栏的代码如下所示：其效果如图 6-54 所示。

图 6-54 隐藏菜单栏 

也可以使用循环语句来隐藏所有的菜单项：

如果要隐藏全部的菜单项，代码可以为：

设置的属性不同，最后得到的效果也不相同，如图 6-55 所示。

图 6-55 设置 Visible 与 Enabled 属性的区别 

6.5.3 显示或隐藏工具栏 

默认情况下，Excel 窗口中显示的工具栏只有【常用】工具栏和【格式】工具栏，如图 6-56 所示。

图 6-56 默认显示的工具栏 

可以通过相应的代码来隐藏或显示它们，如图 6-57 所示。

图 6-57 隐藏常用和格式工具栏 

如果 Excel 窗口中显示的工具栏不只两种，如图 6-58 所示。

图 6-58 实际可能会同时显示很多工具栏 

想隐藏窗口中显示的所有工具栏，可以使用程序：其效果如图 6-59 所示。

图 6-59 隐藏所有工具栏 

6.5.4 设置窗口 

还可以对工作表的窗口进行设置，如图 6-60 所示。

图 6-60 设置窗口 

6.5.5 其他设置

### 6.6 典型的技巧或示例 

6.6.1 设计一张调查问卷 

Excel Home 免费培训中心第一期培训结束了，希望通过调查问卷了解学员对培训的评价和建议，因此，需要设计一张调查问卷，如图 6-61 所示。

图 6-61 用 Excel 设计的调查问卷 

问卷的内容包括学员基本资料、单项选择、多项选择和学员建议 4 部分。

设计学员基本资料部分 

设计学员基本资料部分的操作如图 6-62 所示。

图 6-62 设置学员基本资料 

设计单项选择部分 

设计单项选择部分的操作如图 6-63 所示。

图 6-63 设计单项选择部分 

设计多项选择部分 

设计多项选择部分的操作如图 6-64 所示。

图 6-64 设计多项选择部分 

设计其他部分 

其他部分的设计如图 6-65 所示。

图 6-65 其他部分的设计 

装饰问卷界面 

Step 1：设置适合的背景或边框线、字体及其颜色，如图 6-66 所示。

图 6-66 修饰界面 

Step 2：取消显示网格线，如图 6-67 所示。

图 6-67 取消显示网格线 

Step 3：隐藏多余的行和列区域。自动登记调查结果 

为方便统计分析，学员填写完问卷后，要将结果保存到工作簿中的「调查结果」工作表里，如图 6-68 所示，可以编写一个程序来实现这个目的。

图 6-68 保存结果的工作表 

Step 1：插入一个标准模块，在模块中输入程序。

Step 2：在「问卷」工作表中添加一个按钮，更改标签为「提交问卷」，如图 6-69 所示，将编写的程序指定给按钮。

图 6-69 添加按钮 

Step 3：填写并保存问卷结果，如图 6-70 所示。

图 6-70 使用问卷 

保护问卷工作表 

如果你担心设计好的表格会被别人修改，可以锁定该工作表。

Step 1：锁定单元格，如图 6-71 所示。

图 6-71 锁定单元格 

取消锁定要输入数据的单元格，如图 6-72 所示。

图 6-72 取消锁定单元格 

Step 2：保护工作表，如图 6-73 所示。

图 6-73 保护工作表 

6.6.2 职工信息管理界面 

阿强是单位人事部的工作员，负责管理所有职工的档案，如图 6-74 所示。

图 6-74 职工信息表 

带着这个念头，阿强决定动手设计一个职工信息管理界面。设计界面内容，添加 ActiveX 控件 添加 ActiveX 控件，如图 6-75 所示。

图 6-75 添加 ActiveX 控件 

美化界面 

你可以根据需要随意对工作表进行装饰，如设置单元格的边框、底纹、字体、将多余的行和列隐藏，锁定不需要修改的单元格，设置工作表背景等，如图 6-76 所示。

图 6-76 美化后的界面及各个控件的功能 

给控件添加代码 管理界面中每个按钮要达到的目的都可以通过编写不同的事件过程来实现。因为所有的控件都绘制在工作表中，因此所有的事件过程都必须保存在控件所在的工作表对象里。右键单击工作表标签，执行【查看代码】菜单命令，在【代码窗口】中输入代码：

完成后返回工作表区域，退出设计模式，就可以使用设计的界面了。

练习小课堂：利用工作表设计的界面很容易被人改动，试一试，能不能利用窗体来设计这个界面？ 

参考答案：

参阅 6.6.3 小节中设置登录界面的方法。

6.6.3 一个简易的登录窗体 

设计登录窗体界面 

Step 1：新插入一个窗体，用鼠标指针调整大小，直到满意为止，如图 6-77 所示。

图 6-77 新插入的窗体 

Step 2：在窗体上添加控件，如图 6-78 所示。

图 6-78 登录窗体上的控件 

Step 3：更改窗体的名称及标题栏显示的文本，并对窗体作适当装饰，如图 6-79 所示。

图 6-79 设置窗体属性 

Step 4：设置文字框的属性（如字体），特别设置输入密码的文字框的 PasswordChar 属性为「*」，如图 6-80 所示。

图 6-80 设置密码输入框 为控件指定功能 因为只有当用户名和密码都输入正确后，才显示 Excel 的编辑界面，所以在打开工作簿时，应先将 Excel 界面隐藏，同时显示设计的登录窗体。

Step 1：在 ThisWorkbook 模块中写入程序：

Step 2：设置初始用户名和密码。新建名称来保存用户名，如图 6-81 所示。

图 6-81　新建名称保存用户名 再新建一个名称来保存登录密码，名称名为：UserWord，初始密码为：1234。

练习小课堂：为了不让别人在【定义名称】对话框中看到保存用户名和密码的名称，可以将定义的名称隐藏。怎样隐藏名称（参阅 4.6.1 小节），动手试一试。

参考答案：

Step 3：为【确定】按钮添加代码。双击【确定】按钮，在打开的【代码窗口】中输入程序：

Step 4：为【退出】按钮添加代码。双击【退出】按钮，在【代码窗口】中输入程序：

Step 5：为【更改用户名】按钮添加代码。双击【更改用户名】按钮，在【代码窗口】中输入程序：

Step 6：为【更改密码】按钮添加代码。双击【更改密码】按钮，在【代码窗口】中输入程序：

Step 7：设置单击窗体关闭按钮失效，如图 6-82 所示。

图 6-82 设置单击窗体关闭按钮失效 

双击登录窗体的空白处，在【代码窗体】中输入程序：设置完成后保存并关闭工作簿，重新打开它，就可以使用登录窗体了。

1-2『这一小节里的源码很值得研读。（2021-03-20）』—— 未完成

## 0701. 代码调试与优化 

在 Word 里写一篇讲话稿，无论多么认真仔细，都会出现一些失误。如不小心打上几个错别字或写下几个病句等，要想一次性完成一篇优秀的文章而不出现任何错误是极少见的。编写程序也是如此，在编写过程中，总会有一些问题被自己忽略。文章需要修改，代码也需要调试。

### 7.1 VBA 中可能会发生的错误 

7.1.1 编译错误 

如果编写代码时不遵循 VBA 的语法规则，如未定义变量、函数或属性名称拼写错误、语句不配对（如有 If 没有 End If，有 For 没有 Next）等都会引起编译错误，如图 7-1 所示。存在编译错误的程序，运行时系统会显示一个提示对话框，程序不会被执行，如图 7-1 所示。

图 7-1 运行存在编译错误的程序 

7.1.2 运行时错误 

如果程序在运行过程中试图完成一个不可能完成的操作，如除以 0、打开一个不存在的文件、删除一个打开的文件等都会发生运行时错误。运行存在运行时错误的程序，执行到错误代码所在行时，Excel 会显示一个错误提示对话框，如图 7-2 所示。

图 7-2 运行存在运行时错误的程序 

7.1.3 逻辑错误 

当程序中的代码没有语法问题，程序运行时，也没有不能完成的操作，但程序运行结束后，却不能得到预期的结果，这样的错误称为逻辑错误。把 1 到 10 的自然数依次写进 `A1:A10` 单元格，如果程序写成这样：

这个程序里的每句代码都没有语法错误，也没有不能完成的操作，但运行后却不能得到预期的效果，如图 7-3 所示。

图 7-3 程序运行前后 

编写程序时，很多原因都会引起逻辑错误。如：循环变量的初值和终值设置错误，变量类型不正确，代码顺序不正确等，而这些代码单独存在并没有任何问题。同其他两种错误不同，存在逻辑错误的程序，运行后程序会正常执行，Excel 并不会给出任何提示。所以，逻辑错误最难被发现，但在所有错误类型中占的比例却最大。因此，调试代码时，多数时间都是在修改程序中存在的逻辑错误。

### 7.2 VBA 程序的 3 种状态

7.2.1 设计模式 

设计模式是用户设计和编写 VBA 程序时程序所处的模式。当程序处于设计模式时，用户可以对程序进行任意修改。

7.2.2 运行模式

程序正在运行时的模式称为运行模式。在运行模式下，用户可以通过输入输出对话框与程序「对话」，也可以查看程序的代码，但不能修改程序。

7.2.3 中断模式 

中断模式是程序被临时中断执行（暂停执行）时所处的模式。在中断模式下，用户可以检查程序存在的错误或修改程序的代码，可以逐句执行程序，一边发现错误，一边更正错误。

### 7.3 Excel 已经准备好的调试工具

对于不太复杂的程序，寻找错误并不太难。当程序过长时，从满堆的代码中查找和修正错误就要伤神得多。幸运的是，Excel 已经准备好了一套方便有效的代码调试工具，善用它，可以使调试代码的工作变得更简单、更快捷。

7.3.1 让程序进入中断模式 

正因为在中断模式下可以一边运行程序，一边发现错误并修正错误，所以调试代码多数时间都选择在中断模式下进行。

出现编译错误时 

如果程序存在编译错误，运行时系统会自动显示错误提示对话框，如图 7-1 所示。对话框上有两个按钮，单击【帮助】按钮可以查看该错误的帮助信息；单击【确定】按钮即可进入中断模式，如图 7-4 所示。

图 7-4 出现编译错误时 

出现运行时错误 

如果程序存在运行时错误，运行后会停止在发生错误的代码所在行，自动显示错误提示对话框，如图 7-2 所示。这时可以单击对话框上的【调试】按钮让程序进入中断模式，如图 7-5 所示。

图 7-5 出现运行时错误 

中断一个正在执行的程序 

如果程序中没有出现编译错误和运行时错误，程序会一直执行，直到结束。如果出现死循环，会一直执行下去，不会中止。如：如果一个程序正在运行，当按下 `<Esc>` 键或 `<Ctrl+Break>` 组合键后，系统会中断执行它，并弹出提示对话框，如图 7-6 所示，单击对话框上的【调试】按钮即可让程序进入中断模式。

图 7-6 中断一个正在运行的程序 

7.3.2 为程序设置断点 

什么是断点 

断点像公路中途在检查站，当汽车开到这里就得停车接受检查。如果你怀疑程序中某行（或某段）的代码存在问题，可以在该处设置断点。当程序运行到断点所在行时会暂停执行，停止在断点所在行，进入中断模式，如图 7-7 所示。

图 7-7 程序停止在断点所在行 

进入中断模式后，可以按 `<F8>` 键逐句执行程序，观察运行情况，从而发现并修正存在的错误。

给程序设置断点 

方法一：设置断点的方法一，如图 7-8 所示。

图 7-8　利用 `<F9>` 键设置或清除断点 

方法二：设置断点的方法二，如图 7-9 所示。

图 7-9 利用菜单命令设置或清除断点 

方法三：设置断点的方法三，如图 7-10 所示。

图 7-10 单击边界条设置或清除断点 

如果想清除程序中的所有断点，可以依次执行【调试】→【清除所有断点】菜单命令（或按 `<Ctrl+Shift+F9>` 组合键），如图 7-11 所示。

图 7-11 清除程序中的所有断点 

7.3.3 使用 Stop 语句 

给程序设置的断点会在关闭文件的同时自动取消，如果你需要重新打开工作簿后继续使用设置的断点，可以使用 Stop 语句。在程序里加入一个 Stop 语句，就像给程序设置了一个断点，当程序运行到 Stop 语句时，会停止在 Stop 语句所在行，进入中断模式，如图 7-12 所示。

图 7-12 使用 Stop 语句中断程序 

Stop 语句在重新打开文件后依然存在，当不再需要 Stop 语句时，需要手动清除它。

7.3.4 使用立即窗口 

如果你怀疑程序中的错误是因为变量设置错误引起的，可以在程序中使用 `Debug.Print` 语句将程序运行中变量或表达式的值输出到【立即窗口】中，程序运行结束后，在【立即窗口】中查看变量值的变化情况，如图 7-13 所示。

图 7-13 使用立即窗口查看变量的值 

如果程序处于中断模式下，也可以将光标移到变量名称上，直接查看变量的值，如图 7-14 所示。

图 7-14 在中断模式下查看变量的值 

7.3.5 使用本地窗口 

在中断模式下，还可以利用【本地窗口】查看变量的数据类型和当前值，如图 7-15 所示。

图 7-15 使用本地窗口查看变量的值和数据类型 

如果【本地窗口】没有打开，可以依次执行【视图】→【本地窗口】菜单命令打开它，如图 7-16 所示。

图 7-16 调出本地窗口 

7.3.6 使用监视窗口 

在中断模式下还可以使用【监视窗口】观察程序中变量或表达式的值。使用【监视窗口】来监视变量或表达式前，必须先定义要监视的变量或表达式，监视表达式可以在设计模式或中断模式下定义。使用快速监视 使用快速监视如图 7-17 所示。

图 7-17 快速监视 完成后为程序设置断点，运行程序，就可以在【监视窗口】中看到相应的信息了，如图 7-18 所示。

图 7-18 使用监视窗口 

手动添加监视 手动添加监视如图 7-19 所示。

图 7-19 手动添加监视 

只有当程序处于中断模式时才能使用【监视窗口】，所以只有将程序切换到中断模式，【监视窗口】才能正常工作。编辑或删除监视表达式 编辑或删除监视表达式如图 7-20 所示。

图 7-20 编辑或删除监视

### 7.4 错误处理的艺术 

因为总会有许多意想不到的错误发生，如激活一个不存在的工作表，删除一个已经打开的文件，所以无论多么认真和仔细，都不能避免程序在运行时发生错误。但有些错误是可以预先知道的，所以可以在程序中加入一些错误处理的代码，保证程序正常运行。VBA 通过 On Error 语句捕获运行时错误，该语句告诉 VBA，如果运行程序时出现错误应该怎么做。On Error 语句有 3 种形式。

7.4.1 Go Error GoTo 标签 

Go Error GoTo 该语句告诉 VBA，当发生错误时，继续执行标签所在行及之后的代码。没有出现错误的提示对话框，如图 7-21 所示。

图 7-21 使用 On Error 捕获错误 

关于标签的设置，请参阅 3.7.7 小节中对 GoTo 语句的介绍。

7.4.2 On Error Resume Next 

该语句告诉 VBA：如果程序发生错误，继续执行错误行后面的代码。如果在程序中加入 On Error Resume Next 语句，运行程序时，即使程序中存在运行时错误，也不会中断程序，显示错误信息，并且会继续执行错误语句之后的代码。运行这个程序后，无论当前活动工作簿中是否存在 abc 工作表，都不会出现错误信息，也不会出现最后 Msgbox 函数的对话框。

发现了吗？ 

在程序中，总是把 `On Error GoTo 标签` 或 `On Error Resume Next` 放在可能出错的代码之前，这是因为只有 On Error 语句之后出现的运行时错误才能被捕捉到，所以通常把捕捉错误的语句放在程序开始处。

7.4.3 On Error GoTo 0 

使用 On Error GoTo 0 语句后，将关闭对程序中运行时错误的捕捉。如果在 On Error GoTo 0 语句后，代码再出现运行时错误，尽管在程序一开始已经写入 `On Error GoTo 标签` 或 `On Error Resume Next`，运行时错误都不会被捕捉到，如图 7-22 所示。

图 7-22 关闭错误捕捉

### 7.5 让代码跑得更快一些

7.5.1 合理地使用变量 

声明变量为合适的数据类型 

不同的数据类型占据不同大小的内存空间，如表 3-1 所示，数据所占内存空间的大小直接影响计算机处理数据的速度。因此，为了提高程序的效率，在声明变量时，在满足需求的前提下，应该尽量选择占用字节少的数据类型。

尽量不使用 Variant 型数据 

Variant 是 VBA 中一种特殊的数据类型，所有没有声明数据类型的变量都默认为 Variant 型。但 Variant 型所占据的存储空间远远大于其他数据类型，所以除非必须需要，否则应避免声明变量为 Variant 型。不要让变量一直待在内存里 如果一个变量只在一个过程里使用，请不要声明它为公共变量，尽量减少变量的作用域，这是一个好习惯。如果你不再需要使用某个变量（尤其是对象变量）了，请记得释放它，不要让它一直呆在内存里。

7.5.2 避免反复引用相同的对象 

无论是引用对象，还是调用对象的方法或属性，都会用到点（`.`）运算符，每次运行程序，计算机都会对这些点（`.`）运算符进行解析，当点（`.`）运算符过多时，会花去不少的时间。在这个程序中，`ThisWorkbook.Worksheets (1).Range ("A1")` 是每一句代码都反复引用的对象。引用对象不可避免，但当反复引用同一个对象时，可以用一些方法来简化它，从而减少点（`.`）运算符。

使用 With 语句简化引用对象

```c
Public Sub WithTest()
  With ThisWorkbook.Worksheets(1).Range("A1")
    .Clear
    .Value = "Excel Home"
    .Font.Name = "宋体"
    .Font.Size = 16
    .Font.Blod = True
    .Font.ColorIndex = 3
  End With
End Sub
```

还可以使用嵌套的 With 语句进一步简化程序：

```c
Public Sub WithTest()
  With ThisWorkbook.Worksheets(1).Range("A1")
    .Clear
    .Value = "Excel Home"
      .Name = "宋体"
      .Size = 16
      .Blod = True
      .ColorIndex = 3
  End With
End Sub
```

关于 With 语句，请参阅 3.7.7 小节的内容。

使用变量简化引用对象 

除了 With 语句，还可以使用变量来简化对相同对象的引用。如：

还可以借助 With 语句进一步简化输入：

7.5.3 尽量使用函数完成计算 

Excel 已经准备了很多现成的函数（工作表函数和 VBA 内置函数），尽管你可以通过编写程序去实现相同的目的，但对于相同的计算，使用函数比编写程序解决效率要高很多。

7.5.4 去掉多余的激活和选择 

如果你的程序是通过录制宏得到的，那里面一定有很多的激活和选择操作，即 Activate 方法和 Select 方法。如：

这是一个复制单元格的程序，调用了 4 次 Select 方法。但事实上并不需要激活工作表，选中单元格后才能执行复制、粘贴操作，所以这些选中工作表和单元格的代码都是多余的，程序可以简化为：

```c
Range("A1").Copy Sheets("Sheet2").Range("B1")
```

去掉多余的操作，不仅可以让程序更简洁，降低阅读和调试的难度，还能提高程序运行的速度。

7.5.5 合理使用数组 

下面的程序把 1 到 65536 的自然数写入 `A1:A65536` 中。逐个将数据写入单元格，在笔者的电脑上，程序运行的时间是 2.52 秒，如图 7-23 所示。

图 7-23 逐个将数据写入单元格需要的时间 

很明显，这样的操作是比较费时的。如果想提高运行速度，可以先把数据写入数组，再通过数组批量写入单元格，如：

```c
Public Sub InputArr()
  Dim start As Double
  start = Timer
  Dim i As Long, arr(1 To 65536) As Long
  For i = i To 65536
    arr(i) = i
  Next
  Range("A1:A65536").Value = Application.WorksheetFunction.Transpose(arr)
  MsgBox "程序运行的时间约是 " & Format(Timer - start, "0.00") & " 秒"
End Sub
```

使用数组后的程序只需要 0.09 秒的时间，速度提高了 28.1 倍，如图 7-24 所示，差距显而易见。

图 7-24 数组批量写入单元格所需的时间 

1『之前开发用 PHP 写数据进 excel 时就采用的这种高效方式，先把要写的数据全部处理好，放到一个数组里，然后整体把数据插入一块「区域」里。（2021-03-20）』

将一维数组写入 A 列单元格前，必须先使用工作表的 TRANSPOSE 函数将数组进行转置。如果想省去转置的计算步骤，可以直接将数组定义为一个多行一列的二维数组，如：

```c
Public Sub InputArr()
  Dim start As Double
  start = Timer
  Dim i As Long, arr(1 To 65536, 1 To 1) As Long
  For i = i To 65536
    arr(i, 1) = i
  Next
  Range("A1:A65536").Value = arr
  MsgBox "程序运行的时间约是 " & Format(Timer - start, "0.00") & " 秒"
End Sub
```

7.5.6 关闭屏幕更新 

设置 Application 对象的 ScreenUpdate 属性为 False（参阅 4.2.1 小节），在程序运行过程中关闭屏幕更新，可以在一定程度上缩短程序运行的时间。如果你的程序很短，需要做的操作很少，那代码是否优化，也许差别并不大。但如果要处理的数据很多，进行的操作很复杂，编写的程序很长时，优化程序代码是很有必要的。

无论你现在是否接触到这些复杂的问题，但请相信我，养成一个良好的习惯，编写简洁、高效的代码会给你学习和使用 VBA，最终成为一个 VBA 高手带来很大的帮助。